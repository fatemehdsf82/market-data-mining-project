{% extends "admin/base.html" %}
{% load static %}

{% block title %}Database Management | Market Analysis Platform{% endblock %}

{% block extrahead %}
{{ block.super }}
<style>
/* Enhanced Modern Card System */
.section-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-6);
    padding-bottom: var(--space-4);
    border-bottom: 2px solid var(--border-color);
}

.section-badge {
    background: linear-gradient(135deg, var(--primary-color), var(--primary-hover));
    color: white;
    padding: var(--space-2) var(--space-4);
    border-radius: var(--radius-full);
    font-size: var(--font-xs);
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.section-description {
    color: var(--text-secondary);
    font-size: var(--font-base);
    line-height: 1.6;
    margin-bottom: var(--space-8);
}

.modern-grid {
    display: grid !important;
    grid-template-columns: repeat(auto-fit, minmax(380px, 1fr)) !important;
    gap: var(--space-8) !important;
}

.enhanced-card {
    position: relative !important;
    background: var(--bg-primary) !important;
    border: 1px solid var(--border-color) !important;
    border-radius: var(--radius-2xl) !important;
    padding: var(--space-8) !important;
    overflow: hidden !important;
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) !important;
    box-shadow: var(--shadow-lg) !important;
    backdrop-filter: blur(20px) !important;
}

.enhanced-card:hover {
    transform: translateY(-12px) scale(1.02) !important;
    box-shadow: var(--shadow-2xl), 0 25px 50px rgba(37, 99, 235, 0.15) !important;
    border-color: var(--primary-color) !important;
}

.card-gradient {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 6px;
    transform: scaleX(0);
    transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    border-radius: var(--radius-2xl) var(--radius-2xl) 0 0;
}

.enhanced-card:hover .card-gradient {
    transform: scaleX(1);
}

.search-gradient { background: linear-gradient(90deg, #3b82f6, #06b6d4); }
.add-gradient { background: linear-gradient(90deg, #10b981, #059669); }
.edit-gradient { background: linear-gradient(90deg, #f59e0b, #d97706); }
.delete-gradient { background: linear-gradient(90deg, #ef4444, #dc2626); }
.import-gradient { background: linear-gradient(90deg, #8b5cf6, #7c3aed); }
.export-gradient { background: linear-gradient(90deg, #06b6d4, #0891b2); }

.enhanced-card .card-icon {
    width: 80px !important;
    height: 80px !important;
    border-radius: var(--radius-2xl) !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    font-size: var(--font-4xl) !important;
    margin-bottom: var(--space-6) !important;
    position: relative !important;
    overflow: hidden !important;
    transition: all 0.3s ease !important;
}

.enhanced-card:hover .card-icon {
    transform: scale(1.1) rotate(5deg);
}

.search-icon { background: linear-gradient(135deg, #3b82f6, #06b6d4); color: white; }
.add-icon { background: linear-gradient(135deg, #10b981, #059669); color: white; }
.edit-icon { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; }
.delete-icon { background: linear-gradient(135deg, #ef4444, #dc2626); color: white; }
.import-icon { background: linear-gradient(135deg, #8b5cf6, #7c3aed); color: white; }
.export-icon { background: linear-gradient(135deg, #06b6d4, #0891b2); color: white; }

.enhanced-card h4 {
    color: var(--text-primary) !important;
    font-size: var(--font-2xl) !important;
    font-weight: 700 !important;
    margin: 0 0 var(--space-4) 0 !important;
    line-height: 1.3 !important;
}

.enhanced-card p {
    color: var(--text-secondary) !important;
    font-size: var(--font-base) !important;
    line-height: 1.7 !important;
    margin: 0 0 var(--space-6) 0 !important;
}

.card-features {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-2);
    margin-bottom: var(--space-6);
}

.feature-tag {
    background: var(--bg-tertiary);
    color: var(--text-primary);
    padding: var(--space-1) var(--space-3);
    border-radius: var(--radius-full);
    font-size: var(--font-xs);
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: var(--space-1);
    border: 1px solid var(--border-color);
    transition: all 0.2s ease;
}

.enhanced-card:hover .feature-tag {
    background: var(--primary-color);
    color: white;
    border-color: var(--primary-color);
}

.modern-btn {
    background: linear-gradient(135deg, var(--primary-color), var(--primary-hover)) !important;
    border: none !important;
    border-radius: var(--radius-xl) !important;
    padding: var(--space-4) var(--space-8) !important;
    font-weight: 700 !important;
    font-size: var(--font-base) !important;
    color: white !important;
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275) !important;
    position: relative !important;
    overflow: hidden !important;
    min-height: 56px !important;
    backdrop-filter: blur(10px) !important;
    box-shadow: var(--shadow-lg) !important;
}

.modern-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
    transition: left 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275);
}

.modern-btn:hover::before {
    left: 100%;
}

.modern-btn:hover {
    transform: translateY(-3px) scale(1.05) !important;
    box-shadow: var(--shadow-2xl), 0 15px 35px rgba(37, 99, 235, 0.3) !important;
    color: white !important;
}

.btn-success.modern-btn {
    background: linear-gradient(135deg, var(--success-color), #059669) !important;
}

.btn-warning.modern-btn {
    background: linear-gradient(135deg, var(--warning-color), #d97706) !important;
}

.btn-danger.modern-btn {
    background: linear-gradient(135deg, var(--danger-color), #dc2626) !important;
}

.btn-info.modern-btn {
    background: linear-gradient(135deg, var(--info-color), #0891b2) !important;
}

/* Enhanced Statistics Grid */
.dashboard-stats {
    background: var(--bg-secondary) !important;
    border-radius: var(--radius-2xl) !important;
    padding: var(--space-8) !important;
    margin: var(--space-8) 0 !important;
    border: 1px solid var(--border-color) !important;
    box-shadow: var(--shadow-lg) !important;
}

.dashboard-stats h3 {
    color: var(--primary-color) !important;
    font-size: var(--font-2xl) !important;
    font-weight: 700 !important;
    margin: 0 0 var(--space-6) 0 !important;
    display: flex !important;
    align-items: center !important;
    gap: var(--space-3) !important;
}

.stats-grid {
    display: grid !important;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)) !important;
    gap: var(--space-6) !important;
}

.stat-card {
    background: var(--bg-primary) !important;
    border: 1px solid var(--border-color) !important;
    border-radius: var(--radius-xl) !important;
    padding: var(--space-6) !important;
    text-align: center !important;
    transition: all 0.3s ease !important;
    position: relative !important;
    overflow: hidden !important;
}

.stat-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
}

.stat-card:hover {
    transform: translateY(-6px) !important;
    box-shadow: var(--shadow-xl) !important;
    border-color: var(--primary-color) !important;
}

.stat-card h4 {
    color: var(--primary-color) !important;
    font-size: var(--font-4xl) !important;
    font-weight: 800 !important;
    margin: 0 0 var(--space-2) 0 !important;
    font-family: 'Inter', sans-serif !important;
}

.stat-card p {
    color: var(--text-secondary) !important;
    font-size: var(--font-sm) !important;
    font-weight: 600 !important;
    text-transform: uppercase !important;
    letter-spacing: 1px !important;
    margin: 0 !important;
}

/* Enhanced Info Box */
.info-box {
    background: linear-gradient(135deg, var(--bg-tertiary), var(--bg-secondary)) !important;
    border: 1px solid var(--border-color) !important;
    border-radius: var(--radius-2xl) !important;
    padding: var(--space-8) !important;
    margin: var(--space-8) 0 !important;
    border-left: 6px solid var(--primary-color) !important;
    position: relative !important;
    overflow: hidden !important;
}

.info-box::before {
    content: '';
    position: absolute;
    top: 0;
    right: 0;
    width: 100px;
    height: 100px;
    background: radial-gradient(circle, rgba(37, 99, 235, 0.1) 0%, transparent 70%);
    border-radius: 50%;
    transform: translate(30px, -30px);
}

.info-box h4 {
    color: var(--primary-color) !important;
    font-size: var(--font-2xl) !important;
    font-weight: 700 !important;
    margin: 0 0 var(--space-4) 0 !important;
    display: flex !important;
    align-items: center !important;
    gap: var(--space-3) !important;
}

.info-box h5 {
    color: var(--primary-color) !important;
    font-size: var(--font-lg) !important;
    font-weight: 600 !important;
    margin: var(--space-6) 0 var(--space-3) 0 !important;
    display: flex !important;
    align-items: center !important;
    gap: var(--space-2) !important;
}

.info-box ul {
    margin: var(--space-4) 0 !important;
    padding-left: var(--space-6) !important;
}

.info-box li {
    color: var(--text-secondary) !important;
    margin-bottom: var(--space-2) !important;
    line-height: 1.6 !important;
    position: relative !important;
}

.info-box li::marker {
    color: var(--primary-color) !important;
}

/* Responsive Design */
@media (max-width: 1200px) {
    .modern-grid {
        grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)) !important;
        gap: var(--space-6) !important;
    }
}

@media (max-width: 768px) {
    .modern-grid {
        grid-template-columns: 1fr !important;
        gap: var(--space-4) !important;
    }
    
    .enhanced-card {
        padding: var(--space-6) !important;
    }
    
    .enhanced-card .card-icon {
        width: 60px !important;
        height: 60px !important;
        font-size: var(--font-3xl) !important;
    }
    
    .enhanced-card h4 {
        font-size: var(--font-xl) !important;
    }
    
    .section-header {
        flex-direction: column;
        align-items: flex-start;
        gap: var(--space-3);
    }
    
    .stats-grid {
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)) !important;
        gap: var(--space-4) !important;
    }
    
    .stat-card h4 {
        font-size: var(--font-3xl) !important;
    }
}

/* Animation for better UX */
@keyframes cardSlideIn {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.enhanced-card {
    animation: cardSlideIn 0.6s ease-out;
}

.enhanced-card:nth-child(2) { animation-delay: 0.1s; }
.enhanced-card:nth-child(3) { animation-delay: 0.2s; }
.enhanced-card:nth-child(4) { animation-delay: 0.3s; }
.enhanced-card:nth-child(5) { animation-delay: 0.4s; }
.enhanced-card:nth-child(6) { animation-delay: 0.5s; }
    .card-icon {
        font-size: 2.5rem;
        color: var(--primary-color);
        margin-bottom: var(--space-md);
    }
    
    .action-buttons {
        margin-top: var(--space-lg);
    }
    
    .form-mini {
        display: grid;
        grid-template-columns: auto 1fr auto 1fr;
        gap: var(--space-sm);
        align-items: center;
        margin: var(--space-md) 0;
        font-size: 0.85rem;
    }
    
    .form-mini input {
        padding: var(--space-xs) var(--space-sm) !important;
        font-size: 0.8rem !important;
    }
    
    .form-mini label {
        font-size: 0.8rem !important;
        margin: 0 !important;
        min-width: auto !important;
    }
    
    .modal {
        display: none;
        position: fixed;
        z-index: 10000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
        backdrop-filter: blur(5px);
    }
    
    .modal-content {
        background-color: var(--bg-secondary);
        margin: 2% auto;
        padding: var(--space-xl);
        border-radius: var(--radius-lg);
        width: 90%;
        max-width: 1200px;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: var(--shadow-xl);
    }
    
    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--space-lg);
        padding-bottom: var(--space-md);
        border-bottom: 1px solid var(--border-color);
    }
    
    .modal-header h3 {
        margin: 0;
        color: var(--primary-color);
    }
    
    .close {
        color: var(--text-secondary);
        font-size: 2rem;
        font-weight: bold;
        cursor: pointer;
        transition: color 0.3s ease;
    }
    
    .close:hover {
        color: var(--danger-color);
    }
    
    .table-selector {
        margin-bottom: var(--space-lg);
    }
    
    .table-selector select {
        padding: var(--space-md);
        border: 1px solid var(--border-color);
        border-radius: var(--radius-md);
        background: var(--bg-secondary);
        color: var(--text-primary);
        font-size: 1rem;
        width: 100%;
        max-width: 300px;
    }
    
    .filter-section {
        background: var(--bg-tertiary);
        padding: var(--space-lg);
        border-radius: var(--radius-md);
        margin-bottom: var(--space-lg);
    }
    
    .filter-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: var(--space-md);
    }
    
    .data-table-container {
        background: var(--bg-secondary);
        border-radius: var(--radius-md);
        overflow: hidden;
        box-shadow: var(--shadow-sm);
    }
    
    .data-table {
        width: 100%;
        border-collapse: collapse;
    }
    
    .data-table th {
        background: var(--primary-color);
        color: white;
        padding: var(--space-md);
        text-align: left;
        font-weight: 600;
        position: sticky;
        top: 0;
    }
    
    .data-table td {
        padding: var(--space-md);
        border-bottom: 1px solid var(--border-color);
        color: var(--text-primary);
    }
    
    .data-table tbody tr:hover {
        background-color: rgba(65, 118, 144, 0.05);
    }
    
    .editable {
        cursor: pointer;
        position: relative;
    }
    
    .editable:hover {
        background-color: rgba(65, 118, 144, 0.1);
    }
    
    .loading-spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid rgba(65, 118, 144, 0.3);
        border-radius: 50%;
        border-top-color: var(--primary-color);
        animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
        to { transform: rotate(360deg); }
    }
    
    .pagination-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--space-lg);
        background: var(--bg-tertiary);
        border-radius: 0 0 var(--radius-md) var(--radius-md);
    }
    
    .pagination-info {
        color: var(--text-secondary);
        font-size: 0.9rem;
    }
    
    .pagination-buttons {
        display: flex;
        gap: var(--space-sm);
    }
    
    .alert-danger {
        background: linear-gradient(135deg, rgba(186, 33, 33, 0.1) 0%, rgba(220, 53, 69, 0.1) 100%) !important;
        border-left: 4px solid var(--danger-color) !important;
        color: var(--danger-color) !important;
        border-radius: var(--radius-md) !important;
        padding: var(--space-lg) !important;
        margin-bottom: var(--space-xl) !important;
    }
</style>
{% endblock %}

{% block content %}

<div class="dashboard">
    <div class="module">
        <h2><i class="fas fa-database"></i> Advanced Database Management System</h2>
        <div style="padding: var(--space-xl);">
            
            {% if result_message %}
            <div class="alert alert-success">
                <strong><i class="fas fa-check-circle"></i> Success:</strong> {{ result_message }}
            </div>
            {% endif %}
            
            {% if error_message %}
            <div class="alert alert-danger">
                <strong><i class="fas fa-exclamation-triangle"></i> Error:</strong> {{ error_message }}
            </div>
            {% endif %}
            
            <!-- Database CRUD Operations -->
            <div class="action-section">
                <div class="section-header">
                    <h3><i class="fas fa-database"></i> Database CRUD Operations</h3>
                    <div class="section-badge">6 Tools Available</div>
                </div>
                <p class="section-description">Comprehensive data management tools for viewing, editing, and manipulating database records with advanced filtering and bulk operations.</p>
                
                <div class="action-grid modern-grid">
                    <div class="action-card enhanced-card">
                        <div class="card-gradient search-gradient"></div>
                        <div class="card-icon search-icon"><i class="fas fa-search"></i></div>
                        <h4>View & Filter Data</h4>
                        <p>Browse, search, and filter records from any table with advanced filters and pagination support for large datasets</p>
                        <div class="card-features">
                            <span class="feature-tag"><i class="fas fa-filter"></i> Advanced Filters</span>
                            <span class="feature-tag"><i class="fas fa-list"></i> Pagination</span>
                        </div>
                        <div class="action-buttons">
                            <button type="button" class="btn btn-primary modern-btn" onclick="openDataViewer()">
                                <i class="fas fa-table"></i> View Data
                            </button>
                        </div>
                    </div>
                    
                    <div class="action-card enhanced-card">
                        <div class="card-gradient add-gradient"></div>
                        <div class="card-icon add-icon"><i class="fas fa-plus"></i></div>
                        <h4>Add New Records</h4>
                        <p>Insert new data records into any table with real-time validation and bulk import support from multiple file formats</p>
                        <div class="card-features">
                            <span class="feature-tag"><i class="fas fa-check"></i> Validation</span>
                            <span class="feature-tag"><i class="fas fa-upload"></i> Bulk Import</span>
                        </div>
                        <div class="action-buttons">
                            <button type="button" class="btn btn-success modern-btn" onclick="openDataAdder()">
                                <i class="fas fa-plus-circle"></i> Add Data
                            </button>
                        </div>
                    </div>
                    
                    <div class="action-card enhanced-card">
                        <div class="card-gradient edit-gradient"></div>
                        <div class="card-icon edit-icon"><i class="fas fa-edit"></i></div>
                        <h4>Edit Existing Data</h4>
                        <p>Modify existing records with inline editing capabilities and bulk update operations for efficient data management</p>
                        <div class="card-features">
                            <span class="feature-tag"><i class="fas fa-mouse-pointer"></i> Inline Edit</span>
                            <span class="feature-tag"><i class="fas fa-layer-group"></i> Bulk Update</span>
                        </div>
                        <div class="action-buttons">
                            <button type="button" class="btn btn-warning modern-btn" onclick="openDataEditor()">
                                <i class="fas fa-edit"></i> Edit Data
                            </button>
                        </div>
                    </div>
                    
                    <div class="action-card enhanced-card">
                        <div class="card-gradient delete-gradient"></div>
                        <div class="card-icon delete-icon"><i class="fas fa-trash"></i></div>
                        <h4>Delete Records</h4>
                        <p>Remove unwanted data with comprehensive safety confirmations and soft delete options to prevent accidental loss</p>
                        <div class="card-features">
                            <span class="feature-tag"><i class="fas fa-shield-alt"></i> Safe Delete</span>
                            <span class="feature-tag"><i class="fas fa-undo"></i> Recoverable</span>
                        </div>
                        <div class="action-buttons">
                            <button type="button" class="btn btn-danger modern-btn" onclick="openDataDeleter()">
                                <i class="fas fa-trash-alt"></i> Delete Data
                            </button>
                        </div>
                    </div>
                    
                    <div class="action-card enhanced-card">
                        <div class="card-gradient import-gradient"></div>
                        <div class="card-icon import-icon"><i class="fas fa-upload"></i></div>
                        <h4>Bulk Data Import</h4>
                        <p>Import large datasets from CSV, Excel, or JSON files with intelligent column mapping and data transformation tools</p>
                        <div class="card-features">
                            <span class="feature-tag"><i class="fas fa-file-csv"></i> Multi-Format</span>
                            <span class="feature-tag"><i class="fas fa-sitemap"></i> Auto-Map</span>
                        </div>
                        <div class="action-buttons">
                            <button type="button" class="btn btn-info modern-btn" onclick="openBulkImporter()">
                                <i class="fas fa-file-import"></i> Import Data
                            </button>
                        </div>
                    </div>
                    
                    <div class="action-card enhanced-card">
                        <div class="card-gradient export-gradient"></div>
                        <div class="card-icon export-icon"><i class="fas fa-download"></i></div>
                        <h4>Data Export</h4>
                        <p>Export filtered data to various formats including CSV, Excel, JSON, and PDF reports with custom formatting options</p>
                        <div class="card-features">
                            <span class="feature-tag"><i class="fas fa-file-pdf"></i> PDF Reports</span>
                            <span class="feature-tag"><i class="fas fa-palette"></i> Custom Format</span>
                        </div>
                        <div class="action-buttons">
                            <button type="button" class="btn btn-info modern-btn" onclick="openDataExporter()">
                                <i class="fas fa-file-export"></i> Export Data
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Data Processing Actions -->
            <div class="action-section">
                <h3><i class="fas fa-cogs"></i> Data Processing & Analysis</h3>
                
                <div class="action-grid">
                    <div class="action-card">
                        <div class="card-icon"><i class="fas fa-shopping-basket"></i></div>
                        <h4>Refresh Basket Analysis</h4>
                        <p>Recalculate basket analysis data from transaction records with advanced metrics</p>
                        <form method="post" action="" style="margin: 0;">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="refresh_basket_analysis">
                            <div class="action-buttons">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-sync-alt"></i> Refresh Analysis
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <div class="action-card">
                        <div class="card-icon"><i class="fas fa-users"></i></div>
                        <h4>Generate Customer Segments</h4>
                        <p>Perform comprehensive RFM analysis and create behavioral customer segments</p>
                        <form method="post" action="" style="margin: 0;">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="generate_segments">
                            <div class="action-buttons">
                                <button type="submit" class="btn btn-success">
                                    <i class="fas fa-user-friends"></i> Generate Segments
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <div class="action-card">
                        <div class="card-icon"><i class="fas fa-broom"></i></div>
                        <h4>Clean Transaction Data</h4>
                        <p>Remove inconsistent records, fix data quality issues, and optimize database</p>
                        <form method="post" action="" style="margin: 0;">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="clean_data">
                            <div class="action-buttons">
                                <button type="submit" class="btn btn-warning">
                                    <i class="fas fa-broom"></i> Clean Data
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <div class="action-card">
                        <div class="card-icon"><i class="fas fa-chart-line"></i></div>
                        <h4>Generate Association Rules</h4>
                        <p>Create market basket association rules with configurable parameters</p>
                        <form method="post" action="" style="margin: 0;">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="generate_association_rules">
                            <div class="form-mini">
                                <label>Min Support:</label>
                                <input type="number" name="min_support" value="0.01" step="0.001" min="0" max="1">
                                <label>Min Confidence:</label>
                                <input type="number" name="min_confidence" value="0.5" step="0.01" min="0" max="1">
                            </div>
                            <div class="action-buttons">
                                <button type="submit" class="btn btn-info">
                                    <i class="fas fa-link"></i> Generate Rules
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <div class="action-card">
                        <div class="card-icon"><i class="fas fa-database"></i></div>
                        <h4>Database Optimization</h4>
                        <p>Optimize database performance, rebuild indexes, and update statistics</p>
                        <form method="post" action="" style="margin: 0;">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="optimize_database">
                            <div class="action-buttons">
                                <button type="submit" class="btn btn-secondary">
                                    <i class="fas fa-rocket"></i> Optimize DB
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <div class="action-card">
                        <div class="card-icon"><i class="fas fa-shield-alt"></i></div>
                        <h4>Data Backup</h4>
                        <p>Create backups of analysis data and export database snapshots</p>
                        <form method="post" action="" style="margin: 0;">
                            {% csrf_token %}
                            <input type="hidden" name="action" value="backup_data">
                            <div class="action-buttons">
                                <button type="submit" class="btn btn-secondary">
                                    <i class="fas fa-save"></i> Backup Data
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Database Statistics -->
            <div class="dashboard-stats">
                <h3><i class="fas fa-chart-bar"></i> Database Statistics</h3>
                <div class="stats-grid" style="margin-top: var(--space-lg);">
                    <div class="stat-card">
                        <h4>{{ data_stats.total_transactions|default:0 }}</h4>
                        <p>Total Transactions</p>
                    </div>
                    <div class="stat-card">
                        <h4>{{ data_stats.total_products|default:0 }}</h4>
                        <p>Total Products</p>
                    </div>
                    <div class="stat-card">
                        <h4>{{ data_stats.total_households|default:0 }}</h4>
                        <p>Total Households</p>
                    </div>
                    <div class="stat-card">
                        <h4>{{ data_stats.total_campaigns|default:0 }}</h4>
                        <p>Total Campaigns</p>
                    </div>
                    <div class="stat-card">
                        <h4>{{ data_stats.basket_analyses|default:0 }}</h4>
                        <p>Basket Analyses</p>
                    </div>
                    <div class="stat-card">
                        <h4>{{ data_stats.association_rules|default:0 }}</h4>
                        <p>Association Rules</p>
                    </div>
                    <div class="stat-card">
                        <h4>{{ data_stats.customer_segments|default:0 }}</h4>
                        <p>Customer Segments</p>
                    </div>
                </div>
            </div>

            <!-- Guidelines -->
            <div class="info-box">
                <h4><i class="fas fa-info-circle"></i> Database Management Guidelines</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: var(--space-lg); margin-top: var(--space-lg);">
                    <div>
                        <h5><i class="fas fa-shield-alt"></i> Data Safety</h5>
                        <ul>
                            <li>All delete operations require confirmation</li>
                            <li>Bulk operations are limited to prevent timeouts</li>
                            <li>Automatic backups before major changes</li>
                        </ul>
                    </div>
                    <div>
                        <h5><i class="fas fa-rocket"></i> Performance</h5>
                        <ul>
                            <li>Large datasets are paginated for optimal performance</li>
                            <li>Advanced filtering reduces query load</li>
                            <li>Background processing for heavy operations</li>
                        </ul>
                    </div>
                    <div>
                        <h5><i class="fas fa-cogs"></i> Operations</h5>
                        <ul>
                            <li>Real-time validation during data entry</li>
                            <li>Import mapping with preview functionality</li>
                            <li>Export with custom formatting options</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Data Viewer Modal -->
<div id="dataViewerModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-table"></i> Data Viewer</h3>
            <span class="close" onclick="closeModal('dataViewerModal')">&times;</span>
        </div>
        
        <div class="table-selector">
            <label for="viewTableSelect"><strong>Select Table:</strong></label>
            <select id="viewTableSelect" onchange="loadTableData()">
                <option value="">-- Select a table --</option>
                <option value="transactions">Transactions</option>
                <option value="products">Products</option>
                <option value="households">Households</option>
                <option value="campaigns">Campaigns</option>
                <option value="coupons">Coupons</option>
                <option value="basket_analysis">Basket Analysis</option>
                <option value="customer_segments">Customer Segments</option>
                <option value="association_rules">Association Rules</option>
            </select>
        </div>
        
        <div class="filter-section">
            <h4><i class="fas fa-filter"></i> Filters</h4>
            <div class="filter-grid" id="filterGrid">
                <!-- Dynamic filters will be loaded here -->
            </div>
            <div style="margin-top: var(--space-md);">
                <button type="button" class="btn btn-primary" onclick="applyFilters()">
                    <i class="fas fa-search"></i> Apply Filters
                </button>
                <button type="button" class="btn btn-secondary" onclick="clearFilters()">
                    <i class="fas fa-times"></i> Clear Filters
                </button>
            </div>
        </div>
        
        <div class="data-table-container">
            <div id="loadingSpinner" style="text-align: center; padding: var(--space-2xl); display: none;">
                <div class="loading-spinner"></div>
                <p>Loading data...</p>
            </div>
            <table class="data-table" id="dataTable" style="display: none;">
                <thead id="tableHeader"></thead>
                <tbody id="tableBody"></tbody>
            </table>
        </div>
        
        <div class="pagination-controls" id="paginationControls" style="display: none;">
            <div class="pagination-info" id="paginationInfo"></div>
            <div class="pagination-buttons">
                <button type="button" class="btn btn-sm btn-secondary" onclick="previousPage()">
                    <i class="fas fa-chevron-left"></i> Previous
                </button>
                <button type="button" class="btn btn-sm btn-secondary" onclick="nextPage()">
                    Next <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Add more modals for other CRUD operations... -->

<script>
// State
let currentTable = '';
let currentPage = 1;
let totalPages = 1;
let pageSize = 50;

// CSRF helper
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
const csrftoken = getCookie('csrftoken');

function openDataViewer() { document.getElementById('dataViewerModal').style.display = 'block'; }
function openDataAdder() { alert('Add Data UI coming next.'); }
function openDataEditor() { alert('Edit UI coming next. Inline edits work in table.'); }
function openDataDeleter() { alert('Delete UI coming next.'); }
function openBulkImporter() { alert('Bulk import UI coming next.'); }
function openDataExporter() {
    if (!currentTable) { alert('Open viewer and select a table first.'); return; }
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = location.pathname;
    form.style.display = 'none';
    form.innerHTML = `
        <input type="hidden" name="csrfmiddlewaretoken" value="${csrftoken}">
        <input type="hidden" name="action" value="export_data">
        <input type="hidden" name="table_name" value="${currentTable}">
        <input type="hidden" name="filters" value="{}">
    `;
    document.body.appendChild(form);
    form.submit();
}
function closeModal(modalId) { document.getElementById(modalId).style.display = 'none'; }

async function loadTableData() {
    const tableSelect = document.getElementById('viewTableSelect');
    currentTable = tableSelect.value;
    if (!currentTable) {
        document.getElementById('dataTable').style.display = 'none';
        document.getElementById('paginationControls').style.display = 'none';
        return;
    }
    
    // Show loading state
    const spinner = document.getElementById('loadingSpinner');
    const dataTable = document.getElementById('dataTable');
    
    if (spinner) spinner.style.display = 'block';
    if (dataTable) dataTable.style.display = 'none';
    
    generateFilters(currentTable);
    
    // Add timeout safety for loading
    const loadingTimeout = setTimeout(() => {
        if (spinner) spinner.style.display = 'none';
        if (dataTable) dataTable.style.display = 'block';
        alert('Loading timeout - please try again or check your connection.');
        console.log('Data loading timeout');
    }, 30000); // 30 seconds timeout
    try {
        const form = new FormData();
        form.append('csrfmiddlewaretoken', csrftoken);
        form.append('action', 'get_table_data');
        form.append('table_name', currentTable);
        form.append('page', String(currentPage));
        form.append('limit', String(pageSize));
        const search = (document.getElementById('globalSearch') || {value:''}).value;
        form.append('search', search);

        const res = await fetch(location.pathname, { method: 'POST', body: form });
        const json = await res.json();
        
        // Clear timeout since we got response
        clearTimeout(loadingTimeout);
        
        buildTable(json);
        totalPages = json.pages || 1;
        
        if (spinner) spinner.style.display = 'none';
        if (dataTable) dataTable.style.display = 'table';
        
        const paginationControls = document.getElementById('paginationControls');
        if (paginationControls) paginationControls.style.display = 'flex';
        
        updatePaginationInfo(json);
        console.log('Data loaded successfully');
    } catch (e) {
        console.error('Data loading error:', e);
        clearTimeout(loadingTimeout);
        if (spinner) spinner.style.display = 'none';
        if (dataTable) dataTable.style.display = 'block';
        alert('Error loading data: ' + e.message);
    }
}

function generateFilters(table) {
    const filterGrid = document.getElementById('filterGrid');
    filterGrid.innerHTML = '';
    
    // Sample filter generation based on table
    const commonFilters = {
        'transactions': [
            {name: 'household_key', type: 'number', label: 'Household Key'},
            {name: 'product_id', type: 'number', label: 'Product ID'},
            {name: 'sales_value_min', type: 'number', label: 'Min Sales Value', step: '0.01'},
            {name: 'sales_value_max', type: 'number', label: 'Max Sales Value', step: '0.01'}
        ],
        'products': [
            {name: 'product_id', type: 'number', label: 'Product ID'},
            {name: 'department', type: 'text', label: 'Department'},
            {name: 'brand', type: 'text', label: 'Brand'}
        ],
        'households': [
            {name: 'household_key', type: 'number', label: 'Household Key'},
            {name: 'age_desc', type: 'text', label: 'Age Description'},
            {name: 'income_desc', type: 'text', label: 'Income Description'}
        ]
    };
    
    const filters = commonFilters[table] || [];
    
    // Add a global search field first
    const searchDiv = document.createElement('div');
    searchDiv.innerHTML = `
        <label for="globalSearch">Search:</label>
        <input type="text" id="globalSearch" placeholder="Type to search">
    `;
    filterGrid.appendChild(searchDiv);

    filters.forEach(filter => {
        const filterDiv = document.createElement('div');
        filterDiv.innerHTML = `
            <label for="${filter.name}">${filter.label}:</label>
            <input type="${filter.type}" id="${filter.name}" name="${filter.name}" 
                   ${filter.step ? `step="${filter.step}"` : ''} 
                   placeholder="Enter ${filter.label.toLowerCase()}">
        `;
        filterGrid.appendChild(filterDiv);
    });
}

function buildTable(json) {
    const header = document.getElementById('tableHeader');
    const body = document.getElementById('tableBody');
    header.innerHTML = '';
    body.innerHTML = '';
    if (!json || !json.data || !json.data.length) { return; }
    const keys = Object.keys(json.data[0]);
    const headerRow = document.createElement('tr');
    keys.forEach(k => { const th = document.createElement('th'); th.textContent = k.replace(/_/g,' ').toUpperCase(); headerRow.appendChild(th); });
    header.appendChild(headerRow);

    json.data.forEach(row => {
        const tr = document.createElement('tr');
        const recordId = row.id || row.product_id || row.household_key || row.pk || '';
        tr.dataset.recordId = recordId;
        keys.forEach(k => {
            const td = document.createElement('td');
            td.textContent = row[k];
            td.dataset.field = k;
            // Allow inline edit only for updatable tables
            const editable = (currentTable !== 'transactions');
            if (editable) {
                td.classList.add('editable');
                td.onclick = () => editCell(td, recordId, k);
            }
            tr.appendChild(td);
        });
        body.appendChild(tr);
    });
}

function editCell(cell, recordId, field) {
    if (!recordId) return; // skip when unknown
    const currentValue = cell.textContent;
    const input = document.createElement('input');
    input.type = 'text';
    input.value = currentValue;
    input.style.width = '100%';
    input.addEventListener('blur', async () => {
        cell.textContent = input.value;
        const payload = new FormData();
        payload.append('csrfmiddlewaretoken', csrftoken);
        payload.append('action', 'update_record');
        payload.append('table_name', currentTable);
        payload.append('record_id', String(recordId));
        payload.append('field_data', JSON.stringify({[field]: input.value}));
        try { await fetch(location.pathname, { method:'POST', body: payload }); } catch(e) { console.error(e); }
    });
    input.addEventListener('keypress', (e) => { if (e.key === 'Enter') input.blur(); });
    cell.innerHTML = '';
    cell.appendChild(input);
    input.focus();
}

function applyFilters() { currentPage = 1; loadTableData(); }

function clearFilters() {
    const filterGrid = document.getElementById('filterGrid');
    const inputs = filterGrid.querySelectorAll('input');
    inputs.forEach(input => input.value = '');
    loadTableData(); // Reload without filters
}

function previousPage() { if (currentPage > 1) { currentPage--; loadTableData(); } }
function nextPage() { if (currentPage < totalPages) { currentPage++; loadTableData(); } }
function updatePaginationInfo(json) {
    const info = document.getElementById('paginationInfo');
    const total = (json && json.total) ? json.total : 0;
    const start = (currentPage - 1) * pageSize + 1;
    const end = Math.min(currentPage * pageSize, total);
    info.textContent = `Showing ${start}-${end} of ${total} records`;
}

// Global form submission handler to prevent stuck buttons
document.addEventListener('DOMContentLoaded', function() {
    // Add loading states to all forms
    const forms = document.querySelectorAll('form');
    
    forms.forEach(form => {
        form.addEventListener('submit', function(e) {
            const submitBtn = form.querySelector('button[type="submit"]');
            if (submitBtn && !submitBtn.hasAttribute('data-no-loading')) {
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
                submitBtn.disabled = true;
                
                // Safety timeout to re-enable button
                const timeout = setTimeout(() => {
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                    console.log('Form submission timeout - button re-enabled');
                }, 60000); // 1 minute timeout
                
                // Store timeout ID to clear it if needed
                submitBtn.setAttribute('data-timeout-id', timeout);
            }
        });
    });
    
    // Re-enable buttons on page load (in case of redirect back)
    window.addEventListener('load', function() {
        const buttons = document.querySelectorAll('button[type="submit"]');
        buttons.forEach(btn => {
            if (btn.disabled && btn.innerHTML.includes('Processing')) {
                // Find original text or use default
                btn.innerHTML = btn.getAttribute('data-original-text') || 
                               btn.innerHTML.replace('<i class="fas fa-spinner fa-spin"></i> Processing...', 'Submit');
                btn.disabled = false;
            }
        });
    });
});

// Close modal when clicking outside
window.onclick = function(event) {
    const modals = document.querySelectorAll('.modal');
    modals.forEach(modal => {
        if (event.target === modal) {
            modal.style.display = 'none';
        }
    });
}
</script>
{% endblock %}
