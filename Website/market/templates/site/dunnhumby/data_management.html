{% extends "site/base.html" %}
{% block title %}Data Management{% endblock %}
{% block content %}

<div class="row g-4">
  <div class="col-12">
    <div class="card shadow-sm">
      <div class="card-header" style="background:var(--gradient-primary); color:#fff; font-weight:700;">
        <i class="fas fa-database"></i> Advanced Database Management System
      </div>
      <div class="card-body">
        <!-- Stats row -->
        <div class="row g-4 mb-4">
          <div class="col-6 col-md-4 col-lg-2"><div class="card h-100 shadow-sm"><div class="card-body text-center"><div class="metric-value">{{ data_stats.total_transactions|default:0 }}</div><div class="metric-label">Transactions</div></div></div></div>
          <div class="col-6 col-md-4 col-lg-2"><div class="card h-100 shadow-sm"><div class="card-body text-center"><div class="metric-value">{{ data_stats.total_products|default:0 }}</div><div class="metric-label">Products</div></div></div></div>
          <div class="col-6 col-md-4 col-lg-2"><div class="card h-100 shadow-sm"><div class="card-body text-center"><div class="metric-value">{{ data_stats.total_households|default:0 }}</div><div class="metric-label">Households</div></div></div></div>
          <div class="col-6 col-md-4 col-lg-2"><div class="card h-100 shadow-sm"><div class="card-body text-center"><div class="metric-value">{{ data_stats.total_campaigns|default:0 }}</div><div class="metric-label">Campaigns</div></div></div></div>
          <div class="col-6 col-md-4 col-lg-2"><div class="card h-100 shadow-sm"><div class="card-body text-center"><div class="metric-value">{{ data_stats.basket_analyses|default:0 }}</div><div class="metric-label">Analyses</div></div></div></div>
          <div class="col-6 col-md-4 col-lg-2"><div class="card h-100 shadow-sm"><div class="card-body text-center"><div class="metric-value">{{ data_stats.association_rules|default:0 }}</div><div class="metric-label">Rules</div></div></div></div>
        </div>

        <!-- Actions -->
        <div class="row g-4">
          <div class="col-12 col-md-6 col-lg-3">
            <div class="card h-100 shadow-sm">
              <div class="card-body text-center">
                <div class="tool-icon"><i class="fas fa-search"></i></div>
                <h5>View & Filter Data</h5>
                <p class="text-muted">Browse records with pagination and search</p>
                <button type="button" class="btn btn-primary" onclick="openDataViewer()"><i class="fas fa-table"></i> View Data</button>
              </div>
            </div>
          </div>
          <div class="col-12 col-md-6 col-lg-3">
            <div class="card h-100 shadow-sm">
              <div class="card-body text-center">
                <div class="tool-icon"><i class="fas fa-download"></i></div>
                <h5>Export</h5>
                <p class="text-muted">Download current table as CSV</p>
                <button type="button" class="btn btn-warning" onclick="openDataExporter()"><i class="fas fa-file-export"></i> Export CSV</button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Data Viewer Modal -->
<div id="dataViewerModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3><i class="fas fa-table"></i> Data Viewer</h3>
      <span class="close" onclick="closeModal('dataViewerModal')">&times;</span>
    </div>
    <div class="table-selector">
      <label for="viewTableSelect"><strong>Select Table:</strong></label>
      <select id="viewTableSelect" onchange="loadTableData()">
        <option value="">-- Select a table --</option>
        <option value="transactions">Transactions</option>
        <option value="products">Products</option>
        <option value="households">Households</option>
        <option value="campaigns">Campaigns</option>
        <option value="basket_analysis">Basket Analysis</option>
        <option value="customer_segments">Customer Segments</option>
        <option value="association_rules">Association Rules</option>
      </select>
    </div>
    <div class="filter-section">
      <h4 class="d-flex align-items-center gap-2"><i class="fas fa-filter"></i> <span>Filters</span></h4>
      <div class="row g-3" id="filterGrid"></div>
      <div class="mt-3 d-flex gap-2">
        <button type="button" class="btn btn-primary" onclick="applyFilters()"><i class="fas fa-search"></i> Apply Filters</button>
        <button type="button" class="btn btn-secondary" onclick="clearFilters()"><i class="fas fa-times"></i> Clear Filters</button>
      </div>
    </div>
    <div class="data-table-container">
      <div id="loadingSpinner" style="text-align:center; padding: var(--space-2xl); display:none;"><div class="loading-spinner"></div><p>Loading data...</p></div>
      <table class="table table-hover table-striped table-sm align-middle" id="dataTable" style="display:none;"><thead id="tableHeader"></thead><tbody id="tableBody"></tbody></table>
    </div>
    <div class="pagination-controls" id="paginationControls" style="display:none;">
      <div class="pagination-info" id="paginationInfo"></div>
      <div class="pagination-buttons">
        <button type="button" class="btn btn-sm btn-secondary" onclick="previousPage()"><i class="fas fa-chevron-left"></i> Previous</button>
        <button type="button" class="btn btn-sm btn-secondary" onclick="nextPage()">Next <i class="fas fa-chevron-right"></i></button>
      </div>
    </div>
  </div>
  <style>
    /* Bring modal helpers used in enhanced admin page for consistency */
    .modal{display:none;position:fixed;z-index:10000;left:0;top:0;width:100%;height:100%;background-color:rgba(0,0,0,.5);backdrop-filter:blur(5px);} .modal-content{background:var(--bg-secondary);margin:2% auto;padding:var(--space-xl);border-radius:var(--radius-lg);width:90%;max-width:1200px;max-height:90vh;overflow-y:auto;box-shadow:var(--shadow-xl);} .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:var(--space-lg);padding-bottom:var(--space-md);border-bottom:1px solid var(--border-color);} .close{color:var(--text-secondary);font-size:2rem;font-weight:bold;cursor:pointer}
    .data-table{width:100%;border-collapse:collapse} .data-table th{background:var(--primary-color);color:#fff;padding:var(--space-md);text-align:left;font-weight:600;position:sticky;top:0;} .data-table td{padding:var(--space-md);border-bottom:1px solid var(--border-color);}
  </style>
</div>

<script>
// The same client logic as in admin, but hitting /analysis/api/* endpoints.
let currentTable = '';
let currentPage = 1; let totalPages = 1; let pageSize = 50;
function getCookie(name){let v=null; if(document.cookie&&document.cookie!==''){const c=document.cookie.split(';');for(let i=0;i<c.length;i++){const x=c[i].trim(); if(x.substring(0,name.length+1)===(name+'=')){v=decodeURIComponent(x.substring(name.length+1));break;}}}return v;}
const csrftoken = getCookie('csrftoken');
const schemaCache = {};
function openDataViewer(){document.getElementById('dataViewerModal').style.display='block';}
function openDataExporter(){ if(!currentTable){ alert('Open viewer and select a table first.'); return; } const form = document.createElement('form'); form.method='POST'; form.action='/analysis/api/export/'; form.style.display='none'; form.innerHTML=`<input type="hidden" name="csrfmiddlewaretoken" value="${csrftoken}"><input type="hidden" name="table_name" value="${currentTable}"><input type="hidden" name="filters" value="{}">`; document.body.appendChild(form); form.submit(); }
function closeModal(id){document.getElementById(id).style.display='none';}
async function ensureSchema(table){
  if(schemaCache[table]) return schemaCache[table];
  const res = await fetch(`/analysis/api/schema/?table=${encodeURIComponent(table)}`);
  const json = await res.json();
  schemaCache[table] = json.fields || [];
  return schemaCache[table];
}
function buildFilterControls(fields){
  const grid=document.getElementById('filterGrid'); grid.innerHTML='';
  // Global search
  grid.insertAdjacentHTML('beforeend', `<div class="col-12 col-md-4"><label class="form-label" for="globalSearch">Search</label><input class="form-control" type="text" id="globalSearch" placeholder="Type to search"></div>`);
  fields.forEach(f=>{
    if(f.type==='number'){
      grid.insertAdjacentHTML('beforeend', `<div class="col-6 col-md-3"><label class="form-label" for="${f.name}_min">${f.name} (min)</label><input class="form-control" type="number" id="${f.name}_min"></div>`);
      grid.insertAdjacentHTML('beforeend', `<div class="col-6 col-md-3"><label class="form-label" for="${f.name}_max">${f.name} (max)</label><input class="form-control" type="number" id="${f.name}_max"></div>`);
    } else {
      grid.insertAdjacentHTML('beforeend', `<div class="col-12 col-md-3"><label class="form-label" for="${f.name}">${f.name}</label><input class="form-control" type="text" id="${f.name}" placeholder="Contains..."></div>`);
    }
  });
}
function collectFilters(){
  const fields = schemaCache[currentTable] || [];
  const out = {};
  fields.forEach(f=>{
    if(f.type==='number'){
      const vmin = document.getElementById(`${f.name}_min`)?.value; if(vmin) out[`${f.name}_min`] = vmin;
      const vmax = document.getElementById(`${f.name}_max`)?.value; if(vmax) out[`${f.name}_max`] = vmax;
    } else {
      const v = document.getElementById(f.name)?.value; if(v) out[f.name] = v;
    }
  });
  return out;
}
async function loadTableData(){
  const tableSelect=document.getElementById('viewTableSelect');
  currentTable=tableSelect.value;
  if(!currentTable){document.getElementById('dataTable').style.display='none'; document.getElementById('paginationControls').style.display='none'; return;}
  document.getElementById('loadingSpinner').style.display='block';
  document.getElementById('dataTable').style.display='none';
  // ensure schema and build filters once per table
  const fields = await ensureSchema(currentTable);
  if(!document.getElementById('globalSearch')){ buildFilterControls(fields); }
  try{ const form=new FormData(); form.append('csrfmiddlewaretoken', csrftoken); form.append('table_name', currentTable); form.append('page', String(currentPage)); form.append('limit', String(pageSize)); const search=(document.getElementById('globalSearch')||{value:''}).value; form.append('search', search); form.append('filters', JSON.stringify(collectFilters())); const res=await fetch('/analysis/api/table/', {method:'POST', body:form}); const json=await res.json(); buildTable(json); totalPages=json.pages||1; document.getElementById('loadingSpinner').style.display='none'; document.getElementById('dataTable').style.display='table'; document.getElementById('paginationControls').style.display='flex'; updatePaginationInfo(json);}catch(e){console.error(e); document.getElementById('loadingSpinner').style.display='none';}}
function buildTable(json){ const header=document.getElementById('tableHeader'); const body=document.getElementById('tableBody'); header.innerHTML=''; body.innerHTML=''; if(!json||!json.data||!json.data.length){ body.innerHTML='<tr><td class="text-muted">No records</td></tr>'; return;} const keys=Object.keys(json.data[0]); const hr=document.createElement('tr'); keys.forEach(k=>{const th=document.createElement('th'); th.textContent=k.replace(/_/g,' ').toUpperCase(); th.style.position='sticky'; th.style.top='0'; th.style.background='var(--primary-color)'; th.style.color='#fff'; hr.appendChild(th);}); header.appendChild(hr); json.data.forEach(row=>{const tr=document.createElement('tr'); const recordId=row.id||row.product_id||row.household_key||row.pk||''; keys.forEach(k=>{const td=document.createElement('td'); td.textContent=row[k]; if(recordId && currentTable!=='transactions'){ td.classList.add('editable'); td.onclick=()=>editCell(td, recordId, k);} tr.appendChild(td);}); body.appendChild(tr);}); }
function editCell(cell, recordId, field){ const val=cell.textContent; const input=document.createElement('input'); input.type='text'; input.value=val; input.style.width='100%'; input.addEventListener('blur', async ()=>{ cell.textContent=input.value; const payload=new FormData(); payload.append('csrfmiddlewaretoken', csrftoken); payload.append('table_name', currentTable); payload.append('record_id', String(recordId)); payload.append('field_data', JSON.stringify({[field]: input.value})); try{ await fetch('/analysis/api/update/', {method:'POST', body:payload}); }catch(e){ console.error(e);} }); input.addEventListener('keypress', e=>{ if(e.key==='Enter') input.blur();}); cell.innerHTML=''; cell.appendChild(input); input.focus(); }
function applyFilters(){ currentPage=1; loadTableData(); }
function clearFilters(){ const grid=document.getElementById('filterGrid'); grid.querySelectorAll('input').forEach(i=>i.value=''); currentPage=1; loadTableData(); }
function previousPage(){ if(currentPage>1){ currentPage--; loadTableData(); }}
function nextPage(){ if(currentPage<totalPages){ currentPage++; loadTableData(); }}
function updatePaginationInfo(json){ const info=document.getElementById('paginationInfo'); const total=(json&&json.total)?json.total:0; const start=(currentPage-1)*pageSize+1; const end=Math.min(currentPage*pageSize,total); info.textContent=`Showing ${start}-${end} of ${total} records`; const prevBtn=document.querySelector('#paginationControls .btn.btn-sm.btn-secondary:first-child'); const nextBtn=document.querySelector('#paginationControls .btn.btn-sm.btn-secondary:last-child'); if(prevBtn) prevBtn.disabled = currentPage<=1; if(nextBtn) nextBtn.disabled = currentPage>=totalPages; }
window.onclick=function(e){ const m=document.getElementById('dataViewerModal'); if(e.target===m){ m.style.display='none'; }}
</script>
<!-- Ensure CSRF cookie is set by rendering token once -->
<form style="display:none;">{% csrf_token %}</form>
{% endblock %}
