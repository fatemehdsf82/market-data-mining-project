{% extends "site/base.html" %}
{% block title %}Customer Segmentation{% endblock %}
{% block content %}

<div class="row g-4">
  <div class="col-12">
    <div class="card shadow-sm">
      <div class="card-header" style="background:var(--gradient-primary); color:#fff; font-weight:700;">
        <i class="fas fa-users"></i> Customer Segmentation Dashboard
      </div>
      <div class="card-body">
        <div class="row g-4">
          <div class="col-12">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <h5 class="m-0">RFM Segments Overview</h5>
              {% if segments %}<span class="badge bg-secondary">{{ segments|length }} active segments</span>{% endif %}
            </div>
            {% if segments %}
            <div class="row g-3">
              {% for s in segments %}
              <div class="col-12 col-sm-6 col-md-4 col-lg-3">
                <div class="card h-100 shadow-sm segment-card" data-seg="{{ s.rfm_segment }}" style="cursor:pointer;">
                  <div class="card-body">
                    <div class="d-flex align-items-center justify-content-between mb-2">
                      <span class="badge bg-primary">{{ s.rfm_segment }}</span>
                      <i class="fa-solid fa-layer-group text-muted"></i>
                    </div>
                    <div class="fw-bold fs-5">{{ s.count }}</div>
                    <div class="text-muted small mb-2">Customers</div>
                    <div class="d-flex justify-content-between text-muted small">
                      <div>Avg. Spend<br><span class="fw-semibold text-body">${{ s.avg_spend|floatformat:2 }}</span></div>
                      <div>Avg. Txns<br><span class="fw-semibold text-body">{{ s.avg_transactions|floatformat:1 }}</span></div>
                    </div>
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>
            {% else %}
              <div class="info-box">No segments available. Generate them in Data Management.</div>
            {% endif %}
          </div>
          <div class="col-12">
            <div class="d-flex align-items-center justify-content-between mb-2">
              <h5 class="m-0">Recent Customer Analysis</h5>
              {% if recent_customers %}<small class="text-muted">Detailed profiles with RFM and spending behavior</small>{% endif %}
            </div>
            {% if recent_customers %}
            <div class="row g-3">
              {% for c in recent_customers %}
              <div class="col-12 col-sm-6 col-md-4 col-lg-3">
                <div class="card h-100 shadow-sm household-card" data-household="{{ c.household_key }}" style="cursor:pointer;">
                  <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                      <div class="d-flex align-items-center gap-2"><i class="fa-solid fa-user text-muted"></i><span class="fw-semibold">{{ c.household_key }}</span></div>
                      <span class="badge bg-success">{{ c.rfm_segment }}</span>
                    </div>
                    <div class="d-flex justify-content-between text-center my-2">
                      <div><div class="text-muted small">RECENCY</div><div class="fw-bold fs-5">{{ c.recency_score }}</div></div>
                      <div><div class="text-muted small">FREQUENCY</div><div class="fw-bold fs-5">{{ c.frequency_score }}</div></div>
                      <div><div class="text-muted small">MONETARY</div><div class="fw-bold fs-5">{{ c.monetary_score }}</div></div>
                    </div>
                    <hr class="my-2"/>
                    <div class="row text-center g-2 small text-muted">
                      <div class="col-4">Total Spend<br><span class="text-body fw-semibold">${{ c.total_spend|floatformat:2 }}</span></div>
                      <div class="col-4">Transactions<br><span class="text-body fw-semibold">{{ c.total_transactions }}</span></div>
                      <div class="col-4">Avg. Basket<br><span class="text-body fw-semibold">${{ c.avg_basket_value|floatformat:2 }}</span></div>
                    </div>
                    <div class="text-end small text-muted mt-2">{{ c.updated_at|date:"M d, Y" }}</div>
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>
            {% else %}
              <div class="info-box">No customer data available.</div>
            {% endif %}
          </div>
          
          <!-- RFM Segmentation Guide (text blocks) -->
          <div class="col-12">
            <h5 class="mb-3">RFM Segmentation Guide</h5>
            <div class="row g-4">
              <div class="col-12 col-lg-4">
                <div class="card h-100 shadow-sm">
                  <div class="card-body">
                    <div class="d-flex align-items-center gap-2 mb-2"><i class="fa-solid fa-crown text-warning"></i><strong>High-Value Segments</strong></div>
                    <div class="mb-2"><span class="badge bg-success">Champions</span> High value, high frequency, recent customers — your best customers.</div>
                    <div class="mb-2"><span class="badge bg-primary">Loyal Customers</span> High frequency and monetary value — reliable revenue source.</div>
                  </div>
                </div>
              </div>
              <div class="col-12 col-lg-4">
                <div class="card h-100 shadow-sm">
                  <div class="card-body">
                    <div class="d-flex align-items-center gap-2 mb-2"><i class="fa-solid fa-chart-line text-info"></i><strong>Growth Opportunities</strong></div>
                    <div class="mb-2"><span class="badge bg-info text-dark">Potential Loyalists</span> Recent customers with good frequency — nurture for loyalty.</div>
                    <div class="mb-2"><span class="badge bg-purple" style="background:#8b5cf6;">New Customers</span> Recent but low frequency/monetary — onboarding opportunities.</div>
                  </div>
                </div>
              </div>
              <div class="col-12 col-lg-4">
                <div class="card h-100 shadow-sm">
                  <div class="card-body">
                    <div class="d-flex align-items-center gap-2 mb-2"><i class="fa-solid fa-triangle-exclamation text-danger"></i><strong>At-Risk Segments</strong></div>
                    <div class="mb-2"><span class="badge bg-warning text-dark">Need Attention</span> Good customers who haven't purchased recently — re‑engage.</div>
                    <div class="mb-2"><span class="badge bg-danger">At Risk</span> Were good customers but declining — urgent intervention required.</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function(){
  const csrftoken = (document.cookie.split('; ').find(r=>r.startsWith('csrftoken='))||'').split('=')[1]||'';
  // Segment details
  document.querySelectorAll('.segment-card').forEach(el=>{
    el.addEventListener('click', async ()=>{
      const seg = el.dataset.seg;
      const form = new FormData(); form.append('csrfmiddlewaretoken', csrftoken); form.append('rfm_segment', seg);
      const res = await fetch('/analysis/api/segment/', {method:'POST', body: form});
      const j = await res.json();
      if(j.error){ return showDetailModal('Segment '+seg, '<div class="text-danger">'+j.error+'</div>'); }
      const m = j.metrics||{}; let body = `<div class="row g-3">
        <div class=\"col-3 text-center\"><div class=\"text-muted small\">Customers</div><div class=\"fw-bold\">${m.customers||0}</div></div>
        <div class=\"col-3 text-center\"><div class=\"text-muted small\">Avg Spend</div><div class=\"fw-bold\">$${Number(m.avg_spend||0).toFixed(2)}</div></div>
        <div class=\"col-3 text-center\"><div class=\"text-muted small\">Avg Txns</div><div class=\"fw-bold\">${Number(m.avg_txns||0).toFixed(1)}</div></div>
        <div class=\"col-3 text-center\"><div class=\"text-muted small\">Avg Basket</div><div class=\"fw-bold\">$${Number(m.avg_basket||0).toFixed(2)}</div></div>
      </div>`;
      body += '<h6 class="mt-3">Top Households</h6><div class="table-responsive"><table class="table table-sm align-middle"><thead><tr><th>Household</th><th>Spend</th><th>Txns</th><th>Avg Basket</th><th>R-F-M</th><th>Updated</th></tr></thead><tbody>';
      (j.top_households||[]).forEach(h=>{ body += `<tr><td>${h.household_key}</td><td>$${Number(h.total_spend||0).toFixed(2)}</td><td>${h.total_transactions||0}</td><td>$${Number(h.avg_basket_value||0).toFixed(2)}</td><td>${h.recency_score||'-'}-${h.frequency_score||'-'}-${h.monetary_score||'-'}</td><td>${(h.updated_at||'').toString().slice(0,10)}</td></tr>`; });
      body += '</tbody></table></div>';
      showDetailModal('Segment: '+seg, body);
    });
  });
  // Household details
  document.querySelectorAll('.household-card').forEach(el=>{
    el.addEventListener('click', async ()=>{
      const hh = el.dataset.household;
      const form = new FormData(); form.append('csrfmiddlewaretoken', csrftoken); form.append('household_key', hh);
      const res = await fetch('/analysis/api/household/', {method:'POST', body: form});
      const j = await res.json();
      if(j.error){ return showDetailModal('Household '+hh, '<div class="text-danger">'+j.error+'</div>'); }
      const seg = j.segment||{}; let body = `<div class=\"row g-3\">
        <div class=\"col-4 text-center\"><div class=\"text-muted small\">Segment</div><div class=\"fw-bold\">${seg.rfm_segment||'-'}</div></div>
        <div class=\"col-4 text-center\"><div class=\"text-muted small\">Total Spend</div><div class=\"fw-bold\">$${Number(seg.total_spend||0).toFixed(2)}</div></div>
        <div class=\"col-4 text-center\"><div class=\"text-muted small\">Transactions</div><div class=\"fw-bold\">${seg.total_transactions||0}</div></div>
      </div>`;
      body += `<div class=\"row g-3 mt-2\"><div class=\"col-4 text-center\"><div class=\"text-muted small\">Avg Basket</div><div class=\"fw-bold\">$${Number(seg.avg_basket_value||0).toFixed(2)}</div></div>
        <div class=\"col-8 text-center\"><div class=\"text-muted small\">R-F-M</div><div class=\"fw-bold\">${seg.recency_score||'-'}-${seg.frequency_score||'-'}-${seg.monetary_score||'-'}</div></div></div>`;
      body += '<h6 class="mt-3">Recent Transactions</h6><div class="table-responsive"><table class="table table-sm align-middle"><thead><tr><th>Basket</th><th>Product</th><th>Qty</th><th>Sales</th><th>Day</th></tr></thead><tbody>';
      (j.recent_transactions||[]).forEach(t=>{ body += `<tr><td>${t.basket_id}</td><td>${t.product_id} ${t.commodity_desc?('— '+t.commodity_desc):''}</td><td>${t.quantity}</td><td>$${Number(t.sales_value||0).toFixed(2)}</td><td>${t.day}</td></tr>`; });
      body += '</tbody></table></div>';
      showDetailModal('Household: '+hh, body);
    })
  })
});
</script>

{% endblock %}
