{% extends "site/base.html" %}
{% block title %}Comprehensive Market Basket Analysis | Analytics{% endblock %}

{% block extra_css %}
<style>
:root {
  --grocery-color: #2E86C1;
  --meat-color: #E74C3C;
  --dairy-color: #F39C12;
  --frozen-color: #85C1E9;
  --produce-color: #27AE60;
  --pharmacy-color: #8E44AD;
  --beverage-color: #17A2B8;
  --bakery-color: #D4AC0D;
  --seafood-color: #148F77;
  --deli-color: #FF6B6B;
  --floral-color: #FF69B4;
  --toys-color: #FF1493;
  --video-color: #9C27B0;
  --spirits-color: #795548;
  --default-color: #6C757D;
}

.module {
  max-width: 100%;
  overflow: visible;
  padding: 1rem;
}

.hero-section {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 3rem 2rem 2rem;
  border-radius: 25px;
  margin-bottom: 2rem;
  position: relative;
  overflow: hidden;
}

.hero-section::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 1000" opacity="0.1"><circle cx="200" cy="200" r="3" fill="white"/><circle cx="800" cy="300" r="2" fill="white"/><circle cx="400" cy="600" r="2.5" fill="white"/><circle cx="700" cy="700" r="2" fill="white"/><circle cx="100" cy="800" r="3" fill="white"/></svg>');
  pointer-events: none;
}

.analysis-tabs {
  background: white;
  border-radius: 20px;
  padding: 1.5rem;
  margin-bottom: 2rem;
  box-shadow: 0 10px 30px rgba(0,0,0,0.1);
  max-width: 100%;
}

.tab-buttons {
  display: flex;
  gap: 1rem;
  margin-bottom: 2rem;
  flex-wrap: wrap;
  justify-content: center;
}

.tab-btn {
  padding: 0.8rem 1.5rem;
  border: none;
  border-radius: 15px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  background: #f8f9fa;
  color: #6c757d;
  display: flex;
  align-items: center;
  gap: 0.5rem;
  font-size: 0.9rem;
}

.tab-btn.active {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  transform: translateY(-2px);
  box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
}

.tab-content {
  display: none;
  max-width: 100%;
  padding: 0;
}

.tab-content.active {
  display: block;
  animation: fadeInUp 0.5s ease;
}

.analysis-card, .analysis-type-card {
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  border-radius: 15px;
  padding: 1.2rem;
  margin-bottom: 1rem;
  border-left: 5px solid;
  position: relative;
  overflow: hidden;
  max-width: 100%;
}

.descriptive-card { border-left-color: #28a745; }
.predictive-card { border-left-color: #007bff; }
.differential-card { border-left-color: #dc3545; }

.basket-card, .product-card {
  background: white;
  border-radius: 15px;
  padding: 1.5rem;
  height: 100%;
  box-shadow: 0 8px 25px rgba(0,0,0,0.08);
  transition: all 0.3s ease;
  border: none;
  cursor: pointer;
  position: relative;
  overflow: hidden;
}

.basket-card:hover, .product-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 15px 40px rgba(0,0,0,0.15);
}

.department-badge {
  display: inline-flex;
  align-items: center;
  gap: 0.3rem;
  padding: 0.25rem 0.5rem;
  border-radius: 12px;
  font-weight: 600;
  font-size: 0.7rem;
  color: white;
  text-transform: uppercase;
  letter-spacing: 0.3px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 150px;
}

.section-title {
  font-size: 1.5rem;
  font-weight: 700;
  color: #2d3748;
  margin-bottom: 1.5rem;
  display: flex;
  align-items: center;
  gap: 0.75rem;
}

.metric-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1rem;
  margin: 1.5rem 0;
}

.metric-item {
  background: white;
  padding: 1.5rem;
  border-radius: 15px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.08);
  text-align: center;
  position: relative;
  overflow: hidden;
}

.metric-item::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: linear-gradient(90deg, #667eea, #764ba2);
}

.metric-value {
  font-size: 1.8rem;
  font-weight: 800;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.metric-label {
  font-size: 0.8rem;
  color: #6c757d;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-top: 0.5rem;
}

.chart-container {
  background: white;
  border-radius: 15px;
  padding: 1.2rem;
  margin: 1rem 0;
  box-shadow: 0 8px 25px rgba(0,0,0,0.08);
  max-width: 100%;
  overflow: hidden;
  border: 1px solid #e9ecef;
}

.association-rules-container {
  padding: 1rem;
  border: 1px solid #e9ecef;
  border-radius: 10px;
  margin-top: 1rem;
}

.scrollable-section {
  border: 1px solid #e9ecef;
  border-radius: 10px;
  padding: 1rem;
}

.scrollable-section::-webkit-scrollbar {
  width: 6px;
}

.scrollable-section::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 3px;
}

.scrollable-section::-webkit-scrollbar-thumb {
  background: #667eea;
  border-radius: 3px;
}

.scrollable-section::-webkit-scrollbar-thumb:hover {
  background: #5a67d8;
}

.rule-card {
  cursor: pointer;
  transition: all 0.3s ease;
}

.rule-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

/* Enhanced popup interactivity */
#expandedContent .basket-card {
  cursor: pointer;
  transition: all 0.3s ease;
}

#expandedContent .basket-card:hover {
  transform: translateY(-3px);
  box-shadow: 0 12px 30px rgba(0,0,0,0.2);
  border-left: 4px solid #667eea;
}

#expandedContent .rule-card {
  cursor: pointer;
  transition: all 0.3s ease;
}

#expandedContent .rule-card:hover {
  transform: translateY(-2px) scale(1.02);
  box-shadow: 0 10px 30px rgba(0,0,0,0.15);
  border-left-width: 6px;
}

.rule-card {
  background: white;
  border-radius: 10px;
  padding: 1rem;
  box-shadow: 0 2px 8px rgba(0,0,0,0.06);
  border-left: 4px solid #28a745;
  transition: all 0.3s ease;
  margin-bottom: 0.75rem;
  max-width: 100%;
  overflow: hidden;
  word-wrap: break-word;
}

.rule-card:hover {
  transform: translateX(5px);
  box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

.rule-arrow {
  display: inline-flex;
  align-items: center;
  margin: 0 0.5rem;
  color: #667eea;
  font-size: 1.1rem;
  flex-shrink: 0;
}

.confidence-bar {
  background: #e9ecef;
  height: 6px;
  border-radius: 3px;
  overflow: hidden;
  margin: 0.8rem 0;
}

.confidence-fill {
  height: 100%;
  background: linear-gradient(90deg, #28a745, #20c997);
  border-radius: 3px;
  transition: width 1s ease;
}

.interactive-controls {
  background: #f8f9fa;
  border-radius: 15px;
  padding: 1.5rem;
  margin: 1.5rem 0;
  max-width: 100%;
  overflow: hidden;
}

.control-group {
  display: flex;
  align-items: center;
  gap: 1rem;
  margin-bottom: 1rem;
  flex-wrap: wrap;
}

.control-label {
  font-weight: 600;
  color: #495057;
  min-width: 100px;
}

.control-slider {
  flex: 1;
  min-width: 200px;
  max-width: 300px;
}

.control-value {
  background: #667eea;
  color: white;
  padding: 0.3rem 0.8rem;
  border-radius: 10px;
  font-weight: 600;
  min-width: 60px;
  text-align: center;
}

.algorithm-badge {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 0.2rem 0.6rem;
  border-radius: 10px;
  font-size: 0.7rem;
  font-weight: 600;
  margin-left: 0.5rem;
}

.insights-container {
  padding: 1rem;
  border: 1px solid #e9ecef;
  border-radius: 10px;
  margin-top: 1rem;
}

.fade-in {
  animation: fadeInUp 0.6s ease-out;
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@media (max-width: 768px) {
  .module {
    padding: 0.5rem;
  }
  
  .analysis-tabs {
    padding: 1rem;
  }
  
  .tab-buttons {
    flex-direction: column;
    align-items: center;
    gap: 0.5rem;
  }
  
  .tab-btn {
    width: 100%;
    justify-content: center;
    font-size: 0.8rem;
    padding: 0.6rem 1rem;
  }
  
  .algorithm-badge {
    font-size: 0.6rem;
    padding: 0.1rem 0.4rem;
  }
  
  .control-group {
    flex-direction: column;
    align-items: flex-start;
    gap: 0.5rem;
  }
  
  .control-slider {
    width: 100%;
    min-width: auto;
    max-width: none;
  }
  
  .metric-grid {
    grid-template-columns: repeat(2, 1fr);
    gap: 0.5rem;
  }
  
  .hero-section {
    padding: 1.5rem 1rem;
    margin-bottom: 1rem;
  }
  
  .hero-section h1 {
    font-size: 1.8rem !important;
  }
  
  .association-rules-container,
  .insights-container {
    padding: 0.8rem;
  }
  
  .chart-container {
    padding: 1rem;
  }
  
  .analysis-type-card {
    padding: 1rem;
    margin-bottom: 0.75rem;
  }
}

/* Custom scrollbar for containers */
.association-rules-container::-webkit-scrollbar,
.insights-container::-webkit-scrollbar {
  width: 6px;
}

.association-rules-container::-webkit-scrollbar-track,
.insights-container::-webkit-scrollbar-track {
  background: #f1f1f1;
  border-radius: 3px;
}

.association-rules-container::-webkit-scrollbar-thumb,
.insights-container::-webkit-scrollbar-thumb {
  background: #667eea;
  border-radius: 3px;
}

.tab-content.active {
  display: block;
}

/* Ensure natural scrolling */
html, body {
  overflow-x: hidden;
  overflow-y: auto;
}

* {
  box-sizing: border-box;
}

.row {
  margin-left: 0;
  margin-right: 0;
}
</style>
{% endblock %}

{% block content %}
<div class="module">
  <!-- Hero Section -->
  <div class="hero-section fade-in">
    <div class="text-center">
      <h1 style="font-size: 2.5rem; font-weight: 700; margin-bottom: 1rem;">
        üõí Advanced Market Basket Analysis
      </h1>
      <p style="font-size: 1.1rem; opacity: 0.9; margin: 0;">
        Comprehensive data mining with Descriptive, Predictive & Differential Analysis
      </p>
    </div>
  </div>

  <!-- Analysis Tabs -->
  <div class="analysis-tabs fade-in">
    <div class="tab-buttons">
      <button class="tab-btn active" onclick="switchTab('descriptive')">
        <i class="fas fa-chart-bar"></i>
        Descriptive Analysis
        <span class="algorithm-badge">Apriori & FP-Growth</span>
      </button>
      <button class="tab-btn" onclick="switchTab('predictive')">
        <i class="fas fa-brain"></i>
        Predictive Analysis
        <span class="algorithm-badge">ML Algorithms</span>
      </button>
      <button class="tab-btn" onclick="switchTab('differential')">
        <i class="fas fa-balance-scale"></i>
        Differential Analysis
        <span class="algorithm-badge">Statistical Tests</span>
      </button>
    </div>

    <!-- Descriptive Analysis Tab -->
    <div id="descriptive" class="tab-content active">
      <div class="analysis-type-card descriptive-card">
        <h4 style="color: #28a745; margin-bottom: 1rem;">
          <i class="fas fa-search-plus"></i>
          Descriptive Market Basket Analysis
        </h4>
        <p style="color: #6c757d; line-height: 1.6; margin: 0;">
          Analyzes existing patterns and relationships in transaction data to understand customer behavior, 
          product associations, and optimal store layouts using Apriori and FP-Growth algorithms.
        </p>
      </div>

      <!-- Interactive Controls -->
      <div class="interactive-controls">
        <h5><i class="fas fa-sliders-h"></i> Algorithm Parameters</h5>
        <div class="row g-2">
          <div class="col-md-6">
            <div class="control-group">
              <label class="control-label">Min Support:</label>
              <input type="range" class="form-range control-slider" id="supportSlider" min="0.01" max="0.5" step="0.01" value="0.05">
              <span class="control-value" id="supportValue">0.05</span>
            </div>
          </div>
          <div class="col-md-6">
            <div class="control-group">
              <label class="control-label">Min Confidence:</label>
              <input type="range" class="form-range control-slider" id="confidenceSlider" min="0.1" max="1.0" step="0.01" value="0.6">
              <span class="control-value" id="confidenceValue">0.60</span>
            </div>
          </div>
        </div>
        <button class="btn btn-primary mt-2" onclick="runDescriptiveAnalysis()">
          <i class="fas fa-play"></i> Run Apriori Algorithm
        </button>
      </div>

      <!-- Key Metrics -->
      <div class="metric-grid">
        <div class="metric-item">
          <div class="metric-value" id="totalBaskets">114,156</div>
          <div class="metric-label">Total Baskets<br><small style="color: #6c757d; font-size: 0.6rem;">from 1M+ transactions</small></div>
        </div>
        <div class="metric-item">
          <div class="metric-value" id="avgBasketSize">9.2</div>
          <div class="metric-label">Avg Basket Size<br><small style="color: #6c757d; font-size: 0.6rem;">items per basket</small></div>
        </div>
        <div class="metric-item">
          <div class="metric-value" id="strongRules">0</div>
          <div class="metric-label">Strong Rules Found<br><small style="color: #6c757d; font-size: 0.6rem;">run algorithm to generate</small></div>
        </div>
        <div class="metric-item">
          <div class="metric-value" id="topLift">-</div>
          <div class="metric-label">Highest Lift<br><small style="color: #6c757d; font-size: 0.6rem;">measure of association</small></div>
        </div>
      </div>

      <!-- Association Rules -->
      <div class="chart-container">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="mb-0" id="deptRulesTitle"><i class="fas fa-project-diagram"></i> Association Rules (0/‚àû) ‚Äî Department Level</h5>
          <div>
            <button class="btn btn-outline-primary btn-sm" onclick="expandSection('department')" title="View All in Popup">
              <i class="fas fa-expand-arrows-alt"></i> Expand
            </button>
          </div>
        </div>
        <div class="association-rules-container scrollable-section" id="associationRules" style="max-height: 400px; overflow-y: auto;">
          <div class="text-center py-3 text-muted">
            <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
            <p>Click "Run Apriori Algorithm" to generate association rules...</p>
          </div>
        </div>
      </div>

      <!-- Commodity-level Rules -->
      <div class="chart-container">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="mb-0" id="commodityRulesTitle"><i class="fas fa-boxes-stacked"></i> Association Rules (0/‚àû) ‚Äî Commodity Level</h5>
          <div>
            <button class="btn btn-outline-primary btn-sm" onclick="expandSection('commodity')" title="View All in Popup">
              <i class="fas fa-expand-arrows-alt"></i> Expand
            </button>
          </div>
        </div>
        <div class="association-rules-container scrollable-section" id="associationRulesCommodity" style="max-height: 400px; overflow-y: auto;">
          <div class="text-center py-3 text-muted">
            <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
            <p>Click "Run Apriori Algorithm" to generate commodity-level rules...</p>
          </div>
        </div>
      </div>

      <!-- Baskets Grid -->
      <div class="chart-container">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="mb-0"><i class="fas fa-shopping-basket"></i> High-Value Baskets Analysis</h5>
          <div>
            <button class="btn btn-outline-primary btn-sm" onclick="expandSection('baskets')" title="View All in Popup">
              <i class="fas fa-expand-arrows-alt"></i> Expand
            </button>
          </div>
        </div>
        <div class="row g-3 scrollable-section" id="basketsGrid" style="max-height: 400px; overflow-y: auto;">
        {% for b in basket_stats %}
        <div class="col-12 col-sm-6 col-lg-4 col-xl-3">
          <div class="basket-card fade-in" data-basket-id="{{ b.basket_id }}">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <span style="font-weight: 700; color: #2d3748;">#{{ b.basket_id }}</span>
              <span class="badge bg-success">{{ b.unique_products }} items</span>
            </div>
            <div style="font-size: 1.5rem; font-weight: 800; color: #667eea; margin-bottom: 0.5rem;">
              ${{ b.total_value|floatformat:2 }}
            </div>
            <div style="color: #718096; font-size: 0.9rem;">
              Total Value ‚Ä¢ Qty {{ b.total_items }}
            </div>
          </div>
        </div>
        {% empty %}
        <div class="col-12">
          <div class="text-center py-4">
            <i class="fas fa-shopping-basket fa-3x text-muted mb-3"></i>
            <h5>No basket data available</h5>
            <p class="text-muted">Load transaction data to see basket analysis.</p>
          </div>
        </div>
        {% endfor %}
        </div>
      </div>
    </div>

    <!-- Predictive Analysis Tab -->
    <div id="predictive" class="tab-content">
      <div class="analysis-type-card predictive-card">
        <h4 style="color: #007bff; margin-bottom: 1rem;">
          <i class="fas fa-crystal-ball"></i>
          Predictive Market Basket Analysis
        </h4>
        <p style="color: #6c757d; line-height: 1.6; margin: 0;">
          Uses machine learning algorithms (Neural Networks, Random Forest, SVM) to predict future purchase 
          patterns based on historical data and customer behavior profiles.
        </p>
      </div>

      <!-- ML Algorithm Selection -->
      <div class="interactive-controls">
        <h5><i class="fas fa-robot"></i> Machine Learning Configuration</h5>
        <div class="row g-2">
          <div class="col-md-6">
            <label class="form-label control-label">Algorithm:</label>
            <select class="form-select" id="mlAlgorithm">
              <option value="neural_network">Neural Network</option>
              <option value="random_forest">Random Forest</option>
              <option value="gradient_boost">Gradient Boosting</option>
              <option value="svm">Support Vector Machine</option>
            </select>
          </div>
          <div class="col-md-6">
            <div class="control-group">
              <label class="control-label">Training Size:</label>
              <input type="range" class="form-range control-slider" id="trainingSizeSlider" min="0.6" max="0.9" step="0.05" value="0.8">
              <span class="control-value" id="trainingSizeValue">80%</span>
            </div>
          </div>
        </div>
        <button class="btn btn-primary mt-2" onclick="runPredictiveAnalysis()">
          <i class="fas fa-play"></i> Train & Predict
        </button>
      </div>

      <!-- Prediction Results -->
      <div class="row g-2">
        <div class="col-md-6">
          <div class="chart-container">
            <h5><i class="fas fa-chart-line"></i> Prediction Accuracy</h5>
            <canvas id="accuracyChart" height="250"></canvas>
          </div>
        </div>
        <div class="col-md-6">
          <div class="chart-container">
            <h5><i class="fas fa-target"></i> Customer Lifetime Value</h5>
            <canvas id="clvChart" height="250"></canvas>
          </div>
        </div>
      </div>

      <!-- Recommended Products -->
      <div class="chart-container">
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5 class="mb-0"><i class="fas fa-lightbulb"></i> AI-Powered Product Recommendations</h5>
          <div>
            <button class="btn btn-outline-primary btn-sm" onclick="expandSection('recommendations')" title="View All in Popup">
              <i class="fas fa-expand-arrows-alt"></i> Expand
            </button>
          </div>
        </div>
        <div class="row g-3" id="recommendedProducts">
          <!-- Dynamic content -->
        </div>
      </div>
    </div>

    <!-- Differential Analysis Tab -->
    <div id="differential" class="tab-content">
      <div class="analysis-type-card differential-card">
        <h4 style="color: #dc3545; margin-bottom: 1rem;">
          <i class="fas fa-exchange-alt"></i>
          Differential Market Basket Analysis
        </h4>
        <p style="color: #6c757d; line-height: 1.6; margin: 0;">
          Compares basket patterns between different customer segments, time periods, or store locations 
          using statistical significance tests and cohort analysis.
        </p>
      </div>

      <!-- Comparison Controls -->
      <div class="interactive-controls">
        <h5><i class="fas fa-filter"></i> Comparison Configuration</h5>
        <div class="row g-2">
          <div class="col-md-6">
            <label class="form-label">Compare By:</label>
            <select class="form-select" id="compareBy">
              <option value="time">Time Periods</option>
              <option value="customer_segment">Customer Segments</option>
              <option value="store">Store Locations</option>
              <option value="season">Seasonal Patterns</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">Statistical Test:</label>
            <select class="form-select" id="statTest">
              <option value="chi_square">Chi-Square Test</option>
              <option value="t_test">Student's T-Test</option>
              <option value="mann_whitney">Mann-Whitney U</option>
              <option value="kolmogorov">Kolmogorov-Smirnov</option>
            </select>
          </div>
        </div>
        <button class="btn btn-primary mt-2" onclick="runDifferentialAnalysis()">
          <i class="fas fa-play"></i> Compare Patterns
        </button>
      </div>

      <!-- Comparison Results -->
      <div class="row g-2">
        <div class="col-md-8">
          <div class="chart-container">
            <h5><i class="fas fa-chart-bar"></i> Comparative Analysis Results</h5>
            <canvas id="comparisonChart" height="250"></canvas>
          </div>
        </div>
        <div class="col-md-4">
          <div class="metric-grid">
            <div class="metric-item">
              <div class="metric-value" id="pValue">0.032</div>
              <div class="metric-label">P-Value</div>
            </div>
            <div class="metric-item">
              <div class="metric-value" id="effectSize">0.67</div>
              <div class="metric-label">Effect Size</div>
            </div>
            <div class="metric-item">
              <div class="metric-value" id="significance">95%</div>
              <div class="metric-label">Confidence</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Differential Insights -->
      <div class="chart-container">
        <h5><i class="fas fa-microscope"></i> Key Differential Insights</h5>
        <div class="insights-container" id="differentialInsights">
          <div class="text-center py-3 text-muted">
            <i class="fas fa-chart-line fa-2x mb-2"></i>
            <p>Click "Compare Patterns" to generate differential insights...</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Department mapping with colors and emojis
const DEPARTMENT_CONFIG = {
  'GROCERY': { color: '#2E86C1', emoji: 'üõí', gradient: 'linear-gradient(135deg, #2E86C1, #3498DB)' },
  'MEAT-PCKGD': { color: '#E74C3C', emoji: 'ü•©', gradient: 'linear-gradient(135deg, #E74C3C, #EC7063)' },
  'PORK': { color: '#C0392B', emoji: 'üê∑', gradient: 'linear-gradient(135deg, #C0392B, #E74C3C)' },
  'SEAFOOD': { color: '#148F77', emoji: 'üêü', gradient: 'linear-gradient(135deg, #148F77, #1ABC9C)' },
  'SEAFOOD-PCKGD': { color: '#0E6655', emoji: 'ü¶ê', gradient: 'linear-gradient(135deg, #0E6655, #148F77)' },
  'FROZEN GROCERY': { color: '#85C1E9', emoji: '‚ùÑÔ∏è', gradient: 'linear-gradient(135deg, #85C1E9, #AED6F1)' },
  'DAIRY': { color: '#F39C12', emoji: 'ü•õ', gradient: 'linear-gradient(135deg, #F39C12, #F8C471)' },
  'DELI': { color: '#FF6B6B', emoji: 'ü•™', gradient: 'linear-gradient(135deg, #FF6B6B, #FF8E8E)' },
  'DELI/SNACK BAR': { color: '#FF5722', emoji: 'üå≠', gradient: 'linear-gradient(135deg, #FF5722, #FF7043)' },
  'BAKERY': { color: '#D4AC0D', emoji: 'üçû', gradient: 'linear-gradient(135deg, #D4AC0D, #F1C40F)' },
  'PASTRY': { color: '#D68910', emoji: 'üßÅ', gradient: 'linear-gradient(135deg, #D68910, #E67E22)' },
  'PRODUCE': { color: '#27AE60', emoji: 'ü•¨', gradient: 'linear-gradient(135deg, #27AE60, #2ECC71)' },
  'FLORAL': { color: '#FF69B4', emoji: 'üå∏', gradient: 'linear-gradient(135deg, #FF69B4, #FF1493)' },
  'PHARMACY SUPPLY': { color: '#8E44AD', emoji: 'üíä', gradient: 'linear-gradient(135deg, #8E44AD, #9B59B6)' },
  'RX': { color: '#7D3C98', emoji: 'üíâ', gradient: 'linear-gradient(135deg, #7D3C98, #8E44AD)' },
  'DRUG GM': { color: '#A569BD', emoji: 'ü©π', gradient: 'linear-gradient(135deg, #A569BD, #BB8FCE)' },
  'SPIRITS': { color: '#795548', emoji: 'üç∑', gradient: 'linear-gradient(135deg, #795548, #8D6E63)' },
  'BEVERAGE': { color: '#17A2B8', emoji: 'ü•§', gradient: 'linear-gradient(135deg, #17A2B8, #20C997)' },
  'TOYS': { color: '#FF1493', emoji: 'üß∏', gradient: 'linear-gradient(135deg, #FF1493, #FF69B4)' },
  'VIDEO': { color: '#9C27B0', emoji: 'üì∫', gradient: 'linear-gradient(135deg, #9C27B0, #BA68C8)' },
  'PHOTO': { color: '#607D8B', emoji: 'üì∑', gradient: 'linear-gradient(135deg, #607D8B, #78909C)' },
  'ELECT &PLUMBING': { color: '#FF9800', emoji: 'üîß', gradient: 'linear-gradient(135deg, #FF9800, #FFB74D)' },
  'MISC. TRANS.': { color: '#6C757D', emoji: 'üì¶', gradient: 'linear-gradient(135deg, #6C757D, #868E96)' },
  'MISC SALES TRAN': { color: '#6C757D', emoji: 'üõçÔ∏è', gradient: 'linear-gradient(135deg, #6C757D, #868E96)' },
  'COUP/STR & MFG': { color: '#28A745', emoji: 'üé´', gradient: 'linear-gradient(135deg, #28A745, #34CE57)' },
  'DEFAULT': { color: '#6C757D', emoji: 'üì¶', gradient: 'linear-gradient(135deg, #6C757D, #868E96)' }
};

// Global variables for analysis
let currentAnalysisData = {};
let charts = {};

// Tab switching functionality
function switchTab(tabName) {
  // Hide all tab contents
  document.querySelectorAll('.tab-content').forEach(content => {
    content.classList.remove('active');
  });
  
  // Remove active class from all buttons
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  
  // Show selected tab content
  document.getElementById(tabName).classList.add('active');
  
  // Add active class to clicked button
  event.target.closest('.tab-btn').classList.add('active');
  
  // Initialize tab-specific content
  initializeTab(tabName);
}

function initializeTab(tabName) {
  switch(tabName) {
    case 'descriptive':
      loadDescriptiveAnalysis();
      break;
    case 'predictive':
      loadPredictiveAnalysis();
      break;
    case 'differential':
      loadDifferentialAnalysis();
      break;
  }
}

// Create department badge
function createDepartmentBadge(department) {
  const config = DEPARTMENT_CONFIG[department] || DEPARTMENT_CONFIG['DEFAULT'];
  return `
    <span class="department-badge" style="background: ${config.gradient};">
      ${config.emoji} ${department}
    </span>
  `;
}

// Commodity mapping with colors and emojis (based on actual DB commodities)
const COMMODITY_CONFIG = {
  // Frozen Items
  'FRZN ICE': { color: '#3B82F6', emoji: 'üßä', gradient: 'linear-gradient(135deg, #3B82F6, #60A5FA)' },
  'ICE CREAM/MILK/SHERBTS': { color: '#EC4899', emoji: 'üç¶', gradient: 'linear-gradient(135deg, #EC4899, #F472B6)' },
  
  // Bakery & Bread
  'BREAD': { color: '#D4AC0D', emoji: 'üçû', gradient: 'linear-gradient(135deg, #D4AC0D, #F1C40F)' },
  'COOKIES/CONES': { color: '#8B4513', emoji: 'üç™', gradient: 'linear-gradient(135deg, #8B4513, #A0522D)' },
  'BREAKFAST SWEETS': { color: '#FF6B6B', emoji: 'üßÅ', gradient: 'linear-gradient(135deg, #FF6B6B, #FF8E8E)' },
  
  // Pantry & Condiments  
  'PNT BTR/JELLY/JAMS': { color: '#9C27B0', emoji: 'ü´ô', gradient: 'linear-gradient(135deg, #9C27B0, #BA68C8)' },
  'SPICES & EXTRACTS': { color: '#FF5722', emoji: 'üå∂Ô∏è', gradient: 'linear-gradient(135deg, #FF5722, #FF7043)' },
  
  // Health & Wellness
  'VITAMINS': { color: '#4CAF50', emoji: 'üíä', gradient: 'linear-gradient(135deg, #4CAF50, #66BB6A)' },
  
  // Fresh Produce
  'FRUIT - SHELF STABLE': { color: '#FF9800', emoji: 'üçé', gradient: 'linear-gradient(135deg, #FF9800, #FFB74D)' },
  
  // Beverages
  'SOFT DRINKS': { color: '#2196F3', emoji: 'ü•§', gradient: 'linear-gradient(135deg, #2196F3, #42A5F5)' },
  'COFFEE': { color: '#5D4037', emoji: '‚òï', gradient: 'linear-gradient(135deg, #5D4037, #6D4C41)' },
  'MILK': { color: '#FFF8E1', emoji: 'ü•õ', gradient: 'linear-gradient(135deg, #FFF8E1, #FFFDE7)', textColor: '#333' },
  
  // Snacks
  'CHIPS': { color: '#FFC107', emoji: 'ü•î', gradient: 'linear-gradient(135deg, #FFC107, #FFD54F)' },
  'COOKIES': { color: '#795548', emoji: 'üç™', gradient: 'linear-gradient(135deg, #795548, #8D6E63)' },
  
  // Dairy
  'BUTTER': { color: '#FFEB3B', emoji: 'üßà', gradient: 'linear-gradient(135deg, #FFEB3B, #FFF176)', textColor: '#333' },
  'YOGURT': { color: '#E91E63', emoji: 'ü•õ', gradient: 'linear-gradient(135deg, #E91E63, #F06292)' },
  
  // Pantry Staples
  'PASTA': { color: '#FF7043', emoji: 'üçù', gradient: 'linear-gradient(135deg, #FF7043, #FF8A65)' },
  'TOMATO SAUCE': { color: '#F44336', emoji: 'üçÖ', gradient: 'linear-gradient(135deg, #F44336, #EF5350)' },
  'CEREAL': { color: '#9E9E9E', emoji: 'ü•£', gradient: 'linear-gradient(135deg, #9E9E9E, #BDBDBD)' },
  
  // Frozen Foods
  'PIZZA': { color: '#FF5722', emoji: 'üçï', gradient: 'linear-gradient(135deg, #FF5722, #FF7043)' },
  
  // Sweets & Desserts
  'CHOCOLATE': { color: '#3E2723', emoji: 'üç´', gradient: 'linear-gradient(135deg, #3E2723, #5D4037)' },
  'GRANOLA BARS': { color: '#8BC34A', emoji: 'ü•ú', gradient: 'linear-gradient(135deg, #8BC34A, #9CCC65)' },
  
  // Dairy Products
  'CREAMER': { color: '#FFF3E0', emoji: 'ü•õ', gradient: 'linear-gradient(135deg, #FFF3E0, #FFE0B2)', textColor: '#333' },
  
  // Cleaning
  'DETERGENT': { color: '#00BCD4', emoji: 'üßº', gradient: 'linear-gradient(135deg, #00BCD4, #26C6DA)' },
  'FABRIC SOFTENER': { color: '#E1BEE7', emoji: 'üß∫', gradient: 'linear-gradient(135deg, #E1BEE7, #F3E5F5)', textColor: '#333' },
  
  // Default for unknown commodities
  'NO COMMODITY DESCRIPTION': { color: '#6C757D', emoji: 'üì¶', gradient: 'linear-gradient(135deg, #6C757D, #868E96)' },
  'DEFAULT': { color: '#6C757D', emoji: 'üõí', gradient: 'linear-gradient(135deg, #6C757D, #868E96)' }
};

// Create commodity badge with proper colors and emojis
function createCommodityBadge(name) {
  const config = COMMODITY_CONFIG[name] || COMMODITY_CONFIG['DEFAULT'];
  const textColor = config.textColor || '#ffffff';
  return `
    <span class="commodity-badge" style="
      background: ${config.gradient};
      color: ${textColor};
      font-weight: 600;
      border-radius: 15px;
      padding: 0.25rem 0.6rem;
      font-size: 0.7rem;
      white-space: nowrap;
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      max-width: 140px;
      overflow: hidden;
      text-overflow: ellipsis;
    ">
      ${config.emoji} ${name.length > 12 ? name.substring(0, 10) + '...' : name}
    </span>
  `;
}

// Descriptive Analysis Functions
function loadDescriptiveAnalysis() {
  generateAssociationRules();
  updateSliderValues();
}

function generateAssociationRules() {
  const supportThreshold = parseFloat(document.getElementById('supportSlider')?.value || 0.05);
  const confidenceThreshold = parseFloat(document.getElementById('confidenceSlider')?.value || 0.6);
  
  // Department-level demo rules
  const allRules = [
    { antecedent: 'PORK', consequent: 'GROCERY', support: 0.15, confidence: 0.85, lift: 2.3 },
    { antecedent: 'SEAFOOD', consequent: 'FROZEN GROCERY', support: 0.12, confidence: 0.78, lift: 2.1 },
    { antecedent: 'DELI', consequent: 'BAKERY', support: 0.18, confidence: 0.72, lift: 1.9 },
    { antecedent: 'DAIRY', consequent: 'GROCERY', support: 0.22, confidence: 0.88, lift: 2.5 },
    { antecedent: 'SPIRITS', consequent: 'SEAFOOD', support: 0.08, confidence: 0.65, lift: 1.8 },
    { antecedent: 'PHARMACY SUPPLY', consequent: 'DRUG GM', support: 0.14, confidence: 0.76, lift: 2.2 },
    { antecedent: 'FLORAL', consequent: 'TOYS', support: 0.06, confidence: 0.58, lift: 1.7 },
    { antecedent: 'PRODUCE', consequent: 'GROCERY', support: 0.25, confidence: 0.82, lift: 2.1 },
    { antecedent: 'BEVERAGE', consequent: 'DAIRY', support: 0.16, confidence: 0.74, lift: 1.8 },
    { antecedent: 'MEAT-PCKGD', consequent: 'FROZEN GROCERY', support: 0.11, confidence: 0.69, lift: 1.6 }
  ];
  
  // Filter department rules based on thresholds (simulating Apriori algorithm) - SHOW ALL
  const rules = allRules.filter(rule => 
    rule.support >= supportThreshold && rule.confidence >= confidenceThreshold
  ).sort((a, b) => b.lift - a.lift); // Remove .slice(0, 10) to show ALL results
  
  // Department rules HTML (showing count) with click functionality
  const deptRulesHtml = rules.length > 0 ? rules.map(rule => `
    <div class="rule-card" onclick="showRuleDetails('${rule.antecedent}', '${rule.consequent}', ${rule.support}, ${rule.confidence}, ${rule.lift}, 'department')">
      <div class="d-flex align-items-center justify-content-between mb-2">
        <div class="d-flex align-items-center flex-wrap">
          ${createDepartmentBadge(rule.antecedent)}
          <span class="rule-arrow">‚Üí</span>
          ${createDepartmentBadge(rule.consequent)}
        </div>
        <div class="text-muted small">
          Lift: <strong style="color: #28a745;">${rule.lift}</strong>
        </div>
      </div>
      <div class="row g-2 text-center">
        <div class="col-4">
          <div class="small text-muted">Support</div>
          <div class="fw-bold">${(rule.support * 100).toFixed(1)}%</div>
        </div>
        <div class="col-4">
          <div class="small text-muted">Confidence</div>
          <div class="fw-bold">${(rule.confidence * 100).toFixed(1)}%</div>
        </div>
        <div class="col-4">
          <div class="small text-muted">Lift</div>
          <div class="fw-bold">${rule.lift}</div>
        </div>
      </div>
      <div class="confidence-bar">
        <div class="confidence-fill" style="width: ${rule.confidence * 100}%"></div>
      </div>
    </div>
  `).join('') : '<div class="text-center py-4 text-muted"><i class="fas fa-info-circle fa-2x mb-2"></i><p>No department rules found with current thresholds.<br>Try lowering the support or confidence values.</p></div>';
  
  // Update department rules container
  const containerDept = document.getElementById('associationRules');
  if(containerDept) {
    containerDept.innerHTML = deptRulesHtml;
    // Update section title with count (infinity symbol for unlimited)
    const deptTitle = document.getElementById('deptRulesTitle');
    if(deptTitle) deptTitle.innerHTML = `<i class="fas fa-project-diagram"></i> Association Rules (${rules.length}/‚àû) ‚Äî Department Level`;
  }

  // Commodity-level demo rules (based on commodity_desc)
  const commodityRulesAll = [
    { ant: 'BREAD', con: 'PNT BTR/JELLY/JAMS', support: 0.12, confidence: 0.76, lift: 2.1 },
    { ant: 'BREAKFAST SWEETS', con: 'COFFEE', support: 0.14, confidence: 0.82, lift: 2.3 },
    { ant: 'ICE CREAM/MILK/SHERBTS', con: 'COOKIES/CONES', support: 0.13, confidence: 0.78, lift: 2.2 },
    { ant: 'PNT BTR/JELLY/JAMS', con: 'BREAD', support: 0.12, confidence: 0.74, lift: 2.0 },
    { ant: 'COFFEE', con: 'BREAKFAST SWEETS', support: 0.10, confidence: 0.71, lift: 1.9 },
    { ant: 'COOKIES/CONES', con: 'ICE CREAM/MILK/SHERBTS', support: 0.09, confidence: 0.69, lift: 1.8 },
    { ant: 'BREAD', con: 'FRUIT - SHELF STABLE', support: 0.09, confidence: 0.65, lift: 1.8 },
    { ant: 'SPICES & EXTRACTS', con: 'FRUIT - SHELF STABLE', support: 0.08, confidence: 0.66, lift: 1.7 },
    { ant: 'VITAMINS', con: 'FRZN ICE', support: 0.07, confidence: 0.62, lift: 1.6 },
    { ant: 'FRZN ICE', con: 'VITAMINS', support: 0.06, confidence: 0.58, lift: 1.5 },
    { ant: 'SPICES & EXTRACTS', con: 'VITAMINS', support: 0.05, confidence: 0.55, lift: 1.4 }
  ];
  // Filter commodity rules using SAME thresholds as department rules - SHOW ALL
  const commodityRules = commodityRulesAll.filter(r => 
    r.support >= supportThreshold && r.confidence >= confidenceThreshold
  ).sort((a,b)=>b.lift-a.lift); // Remove .slice(0,10) to show ALL results
  // Commodity rules HTML (showing count) with click functionality
  const commodityHtml = commodityRules.length > 0 ? commodityRules.map(r=>`
    <div class="rule-card" onclick="showRuleDetails('${r.ant}', '${r.con}', ${r.support}, ${r.confidence}, ${r.lift}, 'commodity')">
      <div class="d-flex align-items-center justify-content-between mb-2">
        <div class="d-flex align-items-center flex-wrap">
          ${createCommodityBadge(r.ant)}
          <span class="rule-arrow">‚Üí</span>
          ${createCommodityBadge(r.con)}
        </div>
        <div class="text-muted small">Lift: <strong style="color:#28a745;">${r.lift}</strong></div>
      </div>
      <div class="row g-2 text-center">
        <div class="col-4"><div class="small text-muted">Support</div><div class="fw-bold">${(r.support*100).toFixed(1)}%</div></div>
        <div class="col-4"><div class="small text-muted">Confidence</div><div class="fw-bold">${(r.confidence*100).toFixed(1)}%</div></div>
        <div class="col-4"><div class="small text-muted">Lift</div><div class="fw-bold">${r.lift}</div></div>
      </div>
      <div class="confidence-bar"><div class="confidence-fill" style="width:${r.confidence*100}%"></div></div>
    </div>
  `).join('') : '<div class="text-center py-4 text-muted"><i class="fas fa-info-circle fa-2x mb-2"></i><p>No commodity rules found with current thresholds.<br>Try lowering the support or confidence values.</p></div>';
  
  // Update commodity rules container
  const containerCom = document.getElementById('associationRulesCommodity');
  if(containerCom) {
    containerCom.innerHTML = commodityHtml;
    // Update section title with count (infinity symbol for unlimited)
    const comTitle = document.getElementById('commodityRulesTitle');
    if(comTitle) comTitle.innerHTML = `<i class="fas fa-boxes-stacked"></i> Association Rules (${commodityRules.length}/‚àû) ‚Äî Commodity Level`;
  }
}

function updateSliderValues() {
  const supportSlider = document.getElementById('supportSlider');
  const confidenceSlider = document.getElementById('confidenceSlider');
  const supportValue = document.getElementById('supportValue');
  const confidenceValue = document.getElementById('confidenceValue');
  
  if (supportSlider && supportValue) {
    supportSlider.addEventListener('input', (e) => {
      supportValue.textContent = parseFloat(e.target.value).toFixed(2);
    });
  }
  
  if (confidenceSlider && confidenceValue) {
    confidenceSlider.addEventListener('input', (e) => {
      confidenceValue.textContent = parseFloat(e.target.value).toFixed(2);
    });
  }
}

function runDescriptiveAnalysis() {
  const supportValue = document.getElementById('supportSlider')?.value || 0.05;
  const confidenceValue = document.getElementById('confidenceSlider')?.value || 0.6;
  
  showNotification(`Running Apriori algorithm (min_support=${supportValue}, min_confidence=${confidenceValue})...`, 'info');
  
  // Show loading state for both containers
  const loadingHtml = `
    <div class="text-center py-4">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-2">Mining frequent itemsets...</p>
      <small class="text-muted">Scanning transaction database...</small>
    </div>
  `;
  
  document.getElementById('associationRules').innerHTML = loadingHtml;
  document.getElementById('associationRulesCommodity').innerHTML = loadingHtml;
  
  // Simulate realistic algorithm execution time
  setTimeout(() => {
    generateAssociationRules();
    updateMetrics();
    
    const deptRules = document.getElementById('associationRules').querySelectorAll('.rule-card').length;
    const commodityRules = document.getElementById('associationRulesCommodity').querySelectorAll('.rule-card').length;
    const total = deptRules + commodityRules;
    
    showNotification(`Apriori completed! Found ${total} strong association rules (${deptRules} department + ${commodityRules} commodity).`, 'success');
  }, Math.random() * 2000 + 1500);
}

function updateMetrics() {
  // Count actual rules generated (excluding loading/empty state divs)
  const deptContainer = document.getElementById('associationRules');
  const commodityContainer = document.getElementById('associationRulesCommodity');
  
  const deptRules = deptContainer ? deptContainer.querySelectorAll('.rule-card').length : 0;
  const commodityRules = commodityContainer ? commodityContainer.querySelectorAll('.rule-card').length : 0;
  const totalRules = deptRules + commodityRules;
  
  const elements = {
    strongRules: document.getElementById('strongRules'),
    topLift: document.getElementById('topLift')
  };
  
  if (elements.strongRules) {
    elements.strongRules.textContent = totalRules;
    // Update the label description
    const label = elements.strongRules.nextElementSibling;
    if (label && totalRules > 0) {
      label.innerHTML = `Strong Rules Found<br><small style="color: #6c757d; font-size: 0.6rem;">${deptRules} dept + ${commodityRules} commodity</small>`;
    }
  }
  
  if (elements.topLift && totalRules > 0) {
    elements.topLift.textContent = '2.5';
  }
}

// Predictive Analysis Functions
function loadPredictiveAnalysis() {
  initializePredictiveCharts();
  generateRecommendations();
  updateTrainingSlider();
}

function updateTrainingSlider() {
  const slider = document.getElementById('trainingSizeSlider');
  const value = document.getElementById('trainingSizeValue');
  
  if (slider && value) {
    slider.addEventListener('input', (e) => {
      value.textContent = `${Math.round(parseFloat(e.target.value) * 100)}%`;
    });
  }
}

function initializePredictiveCharts() {
  // Accuracy Chart
  const accuracyCtx = document.getElementById('accuracyChart');
  if (accuracyCtx) {
    charts.accuracy = new Chart(accuracyCtx, {
      type: 'line',
      data: {
        labels: ['Epoch 1', 'Epoch 2', 'Epoch 3', 'Epoch 4', 'Epoch 5'],
        datasets: [{
          label: 'Training Accuracy',
          data: [0.72, 0.78, 0.84, 0.89, 0.92],
          borderColor: '#667eea',
          backgroundColor: 'rgba(102, 126, 234, 0.1)',
          tension: 0.4,
          fill: true
        }, {
          label: 'Validation Accuracy',
          data: [0.68, 0.75, 0.81, 0.85, 0.87],
          borderColor: '#764ba2',
          backgroundColor: 'rgba(118, 75, 162, 0.1)',
          tension: 0.4,
          fill: true
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'top',
            labels: {
              padding: 20,
              usePointStyle: true
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            max: 1
          }
        }
      }
    });
  }
  
  // CLV Chart
  const clvCtx = document.getElementById('clvChart');
  if (clvCtx) {
    charts.clv = new Chart(clvCtx, {
      type: 'scatter',
      data: {
        datasets: [{
          label: 'Predicted CLV',
          data: [
            {x: 120, y: 850}, {x: 200, y: 1200}, {x: 180, y: 950},
            {x: 300, y: 1500}, {x: 250, y: 1100}, {x: 150, y: 750}
          ],
          backgroundColor: 'rgba(102, 126, 234, 0.6)',
          borderColor: '#667eea',
          pointRadius: 6
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            title: {
              display: true,
              text: 'Days Since First Purchase'
            }
          },
          y: {
            title: {
              display: true,
              text: 'Predicted CLV ($)'
            }
          }
        }
      }
    });
  }
}

function generateRecommendations() {
  const algorithm = document.getElementById('mlAlgorithm').value;
  const container = document.getElementById('recommendedProducts');
  
  if (container) {
    container.innerHTML = '<div class="col-12 text-center"><i class="fas fa-spinner fa-spin fa-2x"></i><p>Loading AI-powered recommendations...</p></div>';
  }
  
  // Call ML API for recommendations
  fetch('/analysis/api/ml/recommendations/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
      'X-CSRFToken': getCsrfToken()
    },
    body: `model_type=${algorithm}&top_n=8`
  })
  .then(response => response.json())
  .then(data => {
    if (data.success && data.recommendations.length > 0) {
      const html = data.recommendations.map(rec => `
        <div class="col-md-6 col-lg-3">
          <div class="card h-100 recommendation-card" 
               style="border-left: 4px solid ${DEPARTMENT_CONFIG[rec.department]?.color || '#6C757D'}; cursor: pointer; transition: all 0.3s ease;" 
               data-product-id="${rec.product_id}" 
               data-department="${rec.department}" 
               data-commodity="${rec.commodity || 'All Products'}" 
               data-confidence="${rec.confidence}" 
               data-revenue-impact="${rec.revenue_impact}"
               onmouseover="this.style.transform='translateY(-3px)'; this.style.boxShadow='0 12px 30px rgba(0,0,0,0.2)'"
               onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow=''"
               onclick="showRecommendationDetails('${rec.product_id}', '${rec.department}', '${rec.commodity || 'All Products'}', '${rec.confidence}', '${rec.revenue_impact}')">
            <div class="card-body">
              <div class="d-flex align-items-center mb-2">
                ${createDepartmentBadge(rec.department)}
                <span class="ms-auto badge bg-success">${(rec.confidence * 100).toFixed(0)}%</span>
              </div>
              <h6 class="card-title text-truncate">${rec.commodity || 'All Products'}</h6>
              <div class="fw-bold text-primary fs-5">+$${rec.revenue_impact.toLocaleString()}</div>
              <div class="text-muted small">Predicted Revenue Impact</div>
              <div class="text-muted small mt-1">Product ID: ${rec.product_id}</div>
              <div class="text-muted small mt-1"><i class="fas fa-mouse-pointer"></i> Click for details</div>
            </div>
          </div>
        </div>
      `).join('');
      
      if (container) container.innerHTML = html;
    } else {
      if (container) {
        container.innerHTML = '<div class="col-12 text-center text-muted"><i class="fas fa-exclamation-triangle fa-2x mb-2"></i><p>No recommendations available. Try training the model first.</p></div>';
      }
    }
  })
  .catch(error => {
    console.error('Error loading recommendations:', error);
    if (container) {
      container.innerHTML = '<div class="col-12 text-center text-danger"><i class="fas fa-exclamation-circle fa-2x mb-2"></i><p>Error loading recommendations</p></div>';
    }
  });
}

function runPredictiveAnalysis() {
  const algorithm = document.getElementById('mlAlgorithm').value;
  const trainingSize = document.getElementById('trainingSizeSlider').value;
  
  showNotification(`Training ${algorithm.replace('_', ' ')} model...`, 'info');
  
  // First, train the ML models
  fetch('/analysis/api/ml/train/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
      'X-CSRFToken': getCsrfToken()
    },
    body: `model_type=${algorithm}&training_size=${trainingSize}`
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      showNotification('Model training started successfully!', 'success');
      
      // Poll training status
      checkTrainingStatus(algorithm);
      
      // Load predictions and recommendations
      setTimeout(() => {
        loadPredictiveResults(algorithm);
        generateRecommendations();
      }, 2000);
      
    } else {
      showNotification(`Training failed: ${data.error}`, 'error');
    }
  })
  .catch(error => {
    console.error('Error training model:', error);
    showNotification('Error starting model training', 'error');
  });
}

function checkTrainingStatus(algorithm) {
  const statusInterval = setInterval(() => {
    fetch('/analysis/api/ml/training-status/', {
      method: 'GET',
      headers: {
        'X-CSRFToken': getCsrfToken()
      }
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === 'completed') {
        clearInterval(statusInterval);
        showNotification('Model training completed successfully!', 'success');
        loadModelPerformance(algorithm);
      } else if (data.status === 'failed') {
        clearInterval(statusInterval);
        showNotification('Model training failed', 'error');
      }
    })
    .catch(error => {
      console.error('Error checking training status:', error);
      clearInterval(statusInterval);
    });
  }, 3000);
}

function loadPredictiveResults(algorithm) {
  // Load department predictions
  fetch('/analysis/api/ml/predictions/', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/x-www-form-urlencoded',
      'X-CSRFToken': getCsrfToken()
    },
    body: `model_type=${algorithm}`
  })
  .then(response => response.json())
  .then(data => {
    if (data.success && data.predictions.length > 0) {
      updatePredictiveCharts(data.predictions);
    }
  })
  .catch(error => {
    console.error('Error loading predictions:', error);
  });
}

function loadModelPerformance(algorithm) {
  fetch('/analysis/api/ml/performance/', {
    method: 'GET',
    headers: {
      'X-CSRFToken': getCsrfToken()
    }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success && data.performance) {
      updateAccuracyChart(data.performance);
    }
  })
  .catch(error => {
    console.error('Error loading model performance:', error);
  });
}

// Differential Analysis Functions
function loadDifferentialAnalysis() {
  initializeComparisonChart();
  generateDifferentialInsights();
}

function initializeComparisonChart() {
  const ctx = document.getElementById('comparisonChart');
  if (ctx) {
    charts.comparison = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: ['Q1 2024', 'Q2 2024', 'Q3 2024', 'Q4 2024'],
        datasets: [{
          label: 'Segment A',
          data: [45, 52, 48, 61],
          backgroundColor: 'rgba(102, 126, 234, 0.8)'
        }, {
          label: 'Segment B',
          data: [38, 41, 44, 39],
          backgroundColor: 'rgba(118, 75, 162, 0.8)'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'top'
          }
        }
      }
    });
  }
}

function generateDifferentialInsights() {
  const compareBy = document.getElementById('compareBy')?.value || 'time';
  const statTest = document.getElementById('statTest')?.value || 'chi_square';
  
  const insightMap = {
    'time': [
      {
        title: 'Q4 Holiday Season Peak',
        description: 'FROZEN GROCERY shows 34% higher sales in Q4 vs Q2 (p < 0.01)',
        impact: 'High',
        recommendation: 'Increase frozen inventory 3 weeks before holidays'
      },
      {
        title: 'Summer Beverage Surge',
        description: 'BEVERAGE department peaks in Q3 with 28% increase (p < 0.05)',
        impact: 'Medium',
        recommendation: 'Boost beverage promotions in summer months'
      }
    ],
    'customer_segment': [
      {
        title: 'Premium Customer Preferences',
        description: 'High-value customers purchase 2.3x more SPIRITS (Mann-Whitney U p < 0.001)',
        impact: 'High',
        recommendation: 'Create premium wine and spirits loyalty program'
      },
      {
        title: 'Family Shopping Patterns',
        description: 'Families buy 1.8x more DAIRY and PRODUCE together (œá¬≤ = 45.2, p < 0.01)',
        impact: 'Medium',
        recommendation: 'Place dairy and produce sections adjacently'
      }
    ],
    'store': [
      {
        title: 'Urban vs Suburban Patterns',
        description: 'Urban stores have 45% higher PHARMACY sales (t-test p < 0.001)',
        impact: 'High',
        recommendation: 'Expand health sections in urban locations'
      },
      {
        title: 'Location-Based Preferences',
        description: 'Suburban stores sell 60% more FROZEN items (p < 0.05)',
        impact: 'Medium',
        recommendation: 'Increase frozen food variety in suburban stores'
      }
    ],
    'season': [
      {
        title: 'Winter Comfort Food Trend',
        description: 'BAKERY and DELI purchases increase 42% in winter months',
        impact: 'High',
        recommendation: 'Promote warm, comfort foods during cold seasons'
      }
    ]
  };
  
  const insights = insightMap[compareBy] || insightMap['time'];
  
  const html = insights.map(insight => `
    <div class="card mb-3 border-0 shadow-sm">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between mb-2">
          <h6 class="mb-0 text-primary">${insight.title}</h6>
          <span class="badge ${insight.impact === 'High' ? 'bg-danger' : 'bg-warning'}">${insight.impact} Impact</span>
        </div>
        <p class="text-muted mb-2">${insight.description}</p>
        <div class="bg-light p-2 rounded">
          <small><strong>üí° Recommendation:</strong> ${insight.recommendation}</small>
        </div>
      </div>
    </div>
  `).join('');
  
  const container = document.getElementById('differentialInsights');
  if (container) container.innerHTML = html;
}

function runDifferentialAnalysis() {
  const compareBy = document.getElementById('compareBy')?.value || 'time';
  const statTest = document.getElementById('statTest')?.value || 'chi_square';
  
  showNotification(`Running ${statTest.replace('_', ' ')} test for ${compareBy.replace('_', ' ')} comparison...`, 'info');
  
  // Show loading in insights container
  const container = document.getElementById('differentialInsights');
  if (container) {
    container.innerHTML = `
      <div class="text-center py-4">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2">Running statistical analysis...</p>
        <small class="text-muted">Computing ${statTest.replace('_', ' ')} test...</small>
      </div>
    `;
  }
  
  setTimeout(() => {
    // Update metrics with realistic statistical values
    const pValue = document.getElementById('pValue');
    const effectSize = document.getElementById('effectSize');
    
    if (pValue) pValue.textContent = (Math.random() * 0.049 + 0.001).toFixed(3);
    if (effectSize) effectSize.textContent = (Math.random() * 0.6 + 0.3).toFixed(2);
    
    generateDifferentialInsights();
    showNotification(`${statTest.replace('_', ' ')} analysis completed successfully!`, 'success');
  }, Math.random() * 1500 + 2000);
}

// Expand section in popup
function expandSection(sectionType) {
  let title, content, container;
  
  switch(sectionType) {
    case 'department':
      title = 'All Department Level Association Rules';
      container = document.getElementById('associationRules');
      break;
    case 'commodity':
      title = 'All Commodity Level Association Rules';
      container = document.getElementById('associationRulesCommodity');
      break;
    case 'baskets':
      title = 'All High-Value Baskets';
      container = document.getElementById('basketsGrid');
      break;
    case 'recommendations':
      title = 'All AI-Powered Product Recommendations';
      container = document.getElementById('recommendedProducts');
      break;
  }
  
  if (container) {
    let content = container.innerHTML;
    
    // For baskets and recommendations, wrap in proper bootstrap grid
    if (sectionType === 'baskets' || sectionType === 'recommendations') {
      content = `<div class="row g-3">${content}</div>`;
    }
    
    const modalContent = `
      <div id="expandedContent" style="max-height: 70vh; overflow-y: auto; padding: 1rem; background: #f8f9fa; border-radius: 10px;">
        ${content}
      </div>
    `;
    
    showDetailModal(title, modalContent);
    
    // Re-attach event listeners after modal is shown
    setTimeout(() => {
      attachPopupEventListeners(sectionType);
    }, 200);
  }
}

// Attach event listeners to popup content
function attachPopupEventListeners(sectionType) {
  const expandedContent = document.getElementById('expandedContent');
  if (!expandedContent) return;
  
  if (sectionType === 'baskets') {
    // Attach basket card click handlers
    const basketCards = expandedContent.querySelectorAll('.basket-card');
    basketCards.forEach(card => {
      card.style.cursor = 'pointer';
      card.addEventListener('click', async function() {
        const basketId = this.dataset.basketId;
        if (!basketId) return;
        
        showNotification('Loading basket details...', 'info');
        
        try {
          const csrftoken = (document.cookie.split('; ').find(r=>r.startsWith('csrftoken='))||'').split('=')[1]||'';
          const formData = new FormData();
          formData.append('csrfmiddlewaretoken', csrftoken);
          formData.append('basket_id', basketId);
          
          const response = await fetch('/analysis/api/basket/', {
            method: 'POST',
            body: formData
          });
          
          const data = await response.json();
          
          if (data.error) {
            showDetailModal(`Basket ${basketId}`, `<div class="alert alert-danger">${data.error}</div>`);
            return;
          }
          
          let content = '<div class="table-responsive"><table class="table table-hover"><thead class="table-light"><tr><th>Product</th><th>Quantity</th><th>Sales Value</th><th>Department</th></tr></thead><tbody>';
          
          (data.items || []).forEach(item => {
            const dept = item.department || 'MISC. TRANS.';
            content += `<tr>
              <td><strong>${item.product_id}</strong><br><small class="text-muted">${item.commodity_desc || ''}</small></td>
              <td>${item.quantity}</td>
              <td>$${Number(item.sales_value || 0).toFixed(2)}</td>
              <td>${createDepartmentBadge(dept)}</td>
            </tr>`;
          });
          
          content += '</tbody></table></div>';
          showDetailModal(`üõí Basket #${basketId} Details`, content);
          
        } catch (error) {
          showNotification('Failed to load basket details', 'error');
        }
      });
    });
  } else if (sectionType === 'recommendations') {
    // Attach recommendation card click handlers
    const recommendationCards = expandedContent.querySelectorAll('.recommendation-card');
    recommendationCards.forEach(card => {
      card.style.cursor = 'pointer';
      card.addEventListener('click', function() {
        const productId = this.dataset.productId;
        const department = this.dataset.department;
        const commodity = this.dataset.commodity;
        const confidence = this.dataset.confidence;
        const revenueImpact = this.dataset.revenueImpact;
        
        if (productId) {
          showRecommendationDetails(productId, department, commodity, confidence, revenueImpact);
        }
      });
    });
  } else {
    // Attach rule card click handlers for department and commodity rules
    const ruleCards = expandedContent.querySelectorAll('.rule-card');
    ruleCards.forEach(card => {
      card.style.cursor = 'pointer';
      // Extract data from the card's onclick attribute or recreate the click handler
      const onclickAttr = card.getAttribute('onclick');
      if (onclickAttr) {
        // Parse the onclick parameters
        const match = onclickAttr.match(/showRuleDetails\('([^']+)',\s*'([^']+)',\s*([\d.]+),\s*([\d.]+),\s*([\d.]+),\s*'([^']+)'\)/);
        if (match) {
          const [, antecedent, consequent, support, confidence, lift, ruleType] = match;
          card.addEventListener('click', function() {
            showRuleDetails(antecedent, consequent, parseFloat(support), parseFloat(confidence), parseFloat(lift), ruleType);
          });
        }
      }
    });
  }
}

// Remove the scrollToSection function since we removed the scroll buttons

// Show detailed recommendation information
function showRecommendationDetails(productId, department, commodity, confidence, revenueImpact) {
  const title = `üõí Product Recommendation Details`;
  
  // Parse confidence as a percentage
  const confidencePercent = (parseFloat(confidence) * 100).toFixed(1);
  
  // Format revenue impact
  const formattedRevenue = revenueImpact ? `$${parseInt(revenueImpact).toLocaleString()}` : 'N/A';
  
  // Create department and commodity badges
  const deptBadge = createDepartmentBadge(department || 'N/A');
  const commodityBadge = createCommodityBadge(commodity || 'N/A');
  
  // Get confidence interpretation
  let confidenceLevel = 'Low';
  let confidenceColor = '#dc3545';
  let confidenceDesc = 'This recommendation has low confidence. Consider additional market research.';
  
  if (parseFloat(confidence) >= 0.8) {
    confidenceLevel = 'Very High';
    confidenceColor = '#28a745';
    confidenceDesc = 'This is a highly confident recommendation based on strong predictive patterns.';
  } else if (parseFloat(confidence) >= 0.65) {
    confidenceLevel = 'High';
    confidenceColor = '#20c997';
    confidenceDesc = 'This recommendation shows good confidence with reliable predictive indicators.';
  } else if (parseFloat(confidence) >= 0.5) {
    confidenceLevel = 'Medium';
    confidenceColor = '#ffc107';
    confidenceDesc = 'This recommendation has moderate confidence. Consider combining with other insights.';
  }
  
  const body = `
    <div class="recommendation-details" style="font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;">
      <div class="row mb-4">
        <div class="col-md-6">
          <div class="detail-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem; border-radius: 15px; text-align: center;">
            <h4 style="margin: 0; font-weight: 600;">Product ID</h4>
            <h2 style="margin: 0.5rem 0 0 0; font-size: 2.5rem; font-weight: 700;">${productId}</h2>
          </div>
        </div>
        <div class="col-md-6">
          <div class="detail-card" style="background: linear-gradient(135deg, ${confidenceColor}, ${confidenceColor}dd); color: white; padding: 1.5rem; border-radius: 15px; text-align: center;">
            <h4 style="margin: 0; font-weight: 600;">Confidence</h4>
            <h2 style="margin: 0.5rem 0 0 0; font-size: 2.5rem; font-weight: 700;">${confidencePercent}%</h2>
            <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem; opacity: 0.9;">${confidenceLevel}</p>
          </div>
        </div>
      </div>
      
      <div class="row mb-4">
        <div class="col-md-6">
          <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 10px; border-left: 4px solid #007bff;">
            <h5 style="color: #495057; margin-bottom: 1rem;"><i class="fas fa-building"></i> Department</h5>
            <div>${deptBadge}</div>
          </div>
        </div>
        <div class="col-md-6">
          <div style="background: #f8f9fa; padding: 1.5rem; border-radius: 10px; border-left: 4px solid #28a745;">
            <h5 style="color: #495057; margin-bottom: 1rem;"><i class="fas fa-boxes"></i> Commodity</h5>
            <div>${commodityBadge}</div>
          </div>
        </div>
      </div>
      
      <div class="row mb-4">
        <div class="col-12">
          <div style="background: linear-gradient(135deg, #28a745, #20c997); color: white; padding: 1.5rem; border-radius: 10px; text-align: center;">
            <h5 style="margin: 0 0 0.5rem 0;"><i class="fas fa-dollar-sign"></i> Predicted Revenue Impact</h5>
            <h3 style="margin: 0; font-size: 2rem; font-weight: 700;">${formattedRevenue}</h3>
            <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem; opacity: 0.9;">Estimated additional revenue from this recommendation</p>
          </div>
        </div>
      </div>
      
      <div style="background: #e9ecef; padding: 1.5rem; border-radius: 10px;">
        <h5 style="color: #495057; margin-bottom: 1rem;"><i class="fas fa-lightbulb"></i> AI Analysis</h5>
        <p style="color: #6c757d; margin-bottom: 1rem; line-height: 1.6;">${confidenceDesc}</p>
        
        <h6 style="color: #495057; margin-bottom: 0.5rem;">Recommendation Strategy:</h6>
        <ul style="color: #6c757d; margin: 0; padding-left: 1.5rem;">
          <li>Position this product prominently in the <strong>${department}</strong> section</li>
          <li>Consider cross-merchandising with complementary ${commodity.toLowerCase()} products</li>
          <li>Monitor performance and adjust placement based on actual sales data</li>
          ${parseFloat(confidence) >= 0.7 ? '<li>This high-confidence recommendation is suitable for promotional campaigns</li>' : '<li>Test with smaller inventory quantities before major promotions</li>'}
        </ul>
      </div>
    </div>
  `;
  
  showDetailModal(title, body);
}

// Show detailed rule information
function showRuleDetails(antecedent, consequent, support, confidence, lift, ruleType) {
  const isDepth = ruleType === 'department';
  const antBadge = isDepth ? createDepartmentBadge(antecedent) : createCommodityBadge(antecedent);
  const conBadge = isDepth ? createDepartmentBadge(consequent) : createCommodityBadge(consequent);
  
  const interpretation = getInterpretation(support, confidence, lift);
  const businessValue = getBusinessValue(antecedent, consequent, lift, ruleType);
  
  const title = `${antecedent} ‚Üí ${consequent}`;
  const body = `
    <div class="row g-3">
      <div class="col-12">
        <div class="text-center mb-3">
          <div class="d-flex align-items-center justify-content-center gap-3">
            ${antBadge}
            <i class="fas fa-arrow-right fa-2x text-primary"></i>
            ${conBadge}
          </div>
        </div>
      </div>
      
      <div class="col-md-4">
        <div class="card h-100">
          <div class="card-body text-center">
            <div class="fs-3 fw-bold text-primary">${(support * 100).toFixed(1)}%</div>
            <div class="text-muted">Support</div>
            <small class="text-muted">How often both items appear together</small>
          </div>
        </div>
      </div>
      
      <div class="col-md-4">
        <div class="card h-100">
          <div class="card-body text-center">
            <div class="fs-3 fw-bold text-success">${(confidence * 100).toFixed(1)}%</div>
            <div class="text-muted">Confidence</div>
            <small class="text-muted">When ${antecedent} is bought, likelihood of buying ${consequent}</small>
          </div>
        </div>
      </div>
      
      <div class="col-md-4">
        <div class="card h-100">
          <div class="card-body text-center">
            <div class="fs-3 fw-bold text-warning">${lift}</div>
            <div class="text-muted">Lift</div>
            <small class="text-muted">${lift > 1 ? 'Strong positive' : lift == 1 ? 'Independent' : 'Negative'} association</small>
          </div>
        </div>
      </div>
      
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h6 class="mb-0"><i class="fas fa-chart-line"></i> Rule Interpretation</h6>
          </div>
          <div class="card-body">
            <p class="mb-2"><strong>Statistical Significance:</strong> ${interpretation.significance}</p>
            <p class="mb-2"><strong>Business Meaning:</strong> ${interpretation.meaning}</p>
            <p class="mb-0"><strong>Recommendation:</strong> ${interpretation.recommendation}</p>
          </div>
        </div>
      </div>
      
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <h6 class="mb-0"><i class="fas fa-lightbulb"></i> Business Value</h6>
          </div>
          <div class="card-body">
            <p class="mb-2"><strong>Cross-selling Opportunity:</strong> ${businessValue.crossSell}</p>
            <p class="mb-2"><strong>Store Layout:</strong> ${businessValue.layout}</p>
            <p class="mb-0"><strong>Marketing Strategy:</strong> ${businessValue.marketing}</p>
          </div>
        </div>
      </div>
    </div>
  `;
  
  showDetailModal(title, body);
}

// Get interpretation based on metrics
function getInterpretation(support, confidence, lift) {
  let significance, meaning, recommendation;
  
  if (lift > 2) {
    significance = "Very strong association - much more likely to be purchased together than by chance";
    meaning = "These items have a powerful synergistic relationship in customer behavior";
    recommendation = "Priority for cross-selling campaigns and strategic product placement";
  } else if (lift > 1.5) {
    significance = "Strong association - significantly more likely to be purchased together";
    meaning = "Customers frequently buy these items as complementary products";
    recommendation = "Good candidate for bundling promotions and adjacent placement";
  } else if (lift > 1) {
    significance = "Moderate positive association - somewhat more likely together than separately";
    meaning = "Some connection exists between these items in customer purchasing patterns";
    recommendation = "Consider testing promotional strategies and placement optimization";
  } else {
    significance = "Weak or no association - may be purchased independently";
    meaning = "These items don't show strong purchasing correlation";
    recommendation = "Focus on individual item optimization rather than cross-selling";
  }
  
  return { significance, meaning, recommendation };
}

// Get business value insights
function getBusinessValue(ant, con, lift, type) {
  const crossSell = lift > 1.5 ? 
    `High potential - customers buying ${ant} are ${lift}x more likely to buy ${con}` :
    `Moderate potential - some correlation exists between these items`;
    
  const layout = lift > 1.5 ? 
    `Place these items near each other or in the same aisle for maximum impact` :
    `Current placement is likely adequate, minor adjustments may help`;
    
  const marketing = lift > 2 ? 
    `Bundle these items in promotions, create combo deals, target customers who buy one with ads for the other` :
    `Consider seasonal promotions or targeted email campaigns highlighting the relationship`;
    
  return { crossSell, layout, marketing };
}

// Basket card interactions
document.addEventListener('DOMContentLoaded', function() {
  const csrftoken = (document.cookie.split('; ').find(r=>r.startsWith('csrftoken='))||'').split('=')[1]||'';
  
  // Initialize descriptive analysis by default
  loadDescriptiveAnalysis();
  
  // Basket card clicks
  document.querySelectorAll('.basket-card').forEach(card => {
    card.addEventListener('click', async function() {
      const basketId = this.dataset.basketId;
      showNotification('Loading basket details...', 'info');
      
      try {
        const formData = new FormData();
        formData.append('csrfmiddlewaretoken', csrftoken);
        formData.append('basket_id', basketId);
        
        const response = await fetch('/analysis/api/basket/', {
          method: 'POST',
          body: formData
        });
        
        const data = await response.json();
        
        if (data.error) {
          showDetailModal(`Basket ${basketId}`, `<div class="alert alert-danger">${data.error}</div>`);
          return;
        }
        
        let content = '<div class="table-responsive"><table class="table table-hover"><thead class="table-light"><tr><th>Product</th><th>Quantity</th><th>Sales Value</th><th>Department</th></tr></thead><tbody>';
        
        (data.items || []).forEach(item => {
          const dept = item.department || 'MISC. TRANS.';
          content += `<tr>
            <td><strong>${item.product_id}</strong><br><small class="text-muted">${item.commodity_desc || ''}</small></td>
            <td>${item.quantity}</td>
            <td>$${Number(item.sales_value || 0).toFixed(2)}</td>
            <td>${createDepartmentBadge(dept)}</td>
          </tr>`;
        });
        
        content += '</tbody></table></div>';
        showDetailModal(`üõí Basket #${basketId} Details`, content);
        
      } catch (error) {
        showNotification('Failed to load basket details', 'error');
      }
    });
  });
});

// Helper functions for ML integration
function getCsrfToken() {
  return (document.cookie.split('; ').find(r=>r.startsWith('csrftoken='))||'').split('=')[1]||'';
}

function updatePredictiveCharts(predictions) {
  // Update Customer Lifetime Value Chart
  const clvCtx = document.getElementById('clvChart');
  if (clvCtx && predictions.length > 0) {
    if (charts.clv) charts.clv.destroy();
    
    charts.clv = new Chart(clvCtx, {
      type: 'doughnut',
      data: {
        labels: predictions.slice(0, 5).map(p => p.department),
        datasets: [{
          data: predictions.slice(0, 5).map(p => p.avg_value),
          backgroundColor: predictions.slice(0, 5).map(p => 
            DEPARTMENT_CONFIG[p.department]?.color || '#6C757D'
          )
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              boxWidth: 12,
              font: {
                size: 10
              }
            }
          }
        }
      }
    });
  }
}

function updateAccuracyChart(performance) {
  const accuracyCtx = document.getElementById('accuracyChart');
  if (accuracyCtx && performance) {
    if (charts.accuracy) charts.accuracy.destroy();
    
    const models = Object.keys(performance);
    const accuracyData = models.map(model => (performance[model].accuracy * 100).toFixed(1));
    const precisionData = models.map(model => (performance[model].precision * 100).toFixed(1));
    const recallData = models.map(model => (performance[model].recall * 100).toFixed(1));
    
    charts.accuracy = new Chart(accuracyCtx, {
      type: 'bar',
      data: {
        labels: models.map(m => m.replace('_', ' ').toUpperCase()),
        datasets: [
          {
            label: 'Accuracy',
            data: accuracyData,
            backgroundColor: 'rgba(102, 126, 234, 0.8)',
            borderColor: 'rgba(102, 126, 234, 1)',
            borderWidth: 1
          },
          {
            label: 'Precision',
            data: precisionData,
            backgroundColor: 'rgba(118, 75, 162, 0.8)',
            borderColor: 'rgba(118, 75, 162, 1)',
            borderWidth: 1
          },
          {
            label: 'Recall',
            data: recallData,
            backgroundColor: 'rgba(39, 174, 96, 0.8)',
            borderColor: 'rgba(39, 174, 96, 1)',
            borderWidth: 1
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true,
            max: 100,
            ticks: {
              callback: function(value) {
                return value + '%';
              }
            }
          }
        },
        plugins: {
          legend: {
            position: 'top'
          }
        }
      }
    });
  }
}
</script>

{% endblock %}
